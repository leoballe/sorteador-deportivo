<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sorteador Deportivo</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#0f172a;color:#e5e7eb;margin:0;padding:20px}
.container{max-width:900px;margin:auto;background:#111827;padding:20px;border-radius:12px}
textarea{width:100%;min-height:220px;border-radius:8px;background:#0b1220;color:#e5e7eb;border:1px solid #223046;padding:10px;font-size:14px}
.btn{background:#1f2937;color:#e5e7eb;border:1px solid #374151;border-radius:8px;padding:8px 14px;cursor:pointer;margin-top:8px}
.btn:hover{background:#374151}
ul{list-style:none;padding-left:0}
li{margin:4px 0;display:flex;align-items:center;gap:8px}
input[type=checkbox]{transform:scale(1.2)}
.muted{font-size:12px;color:#94a3b8}
</style>
</head>
<body>
<div class="container">
  <h1>üé≤ Sorteador Deportivo v1.1.2</h1>
  <label>Equipos (uno por l√≠nea o importar CSV)</label>
  <textarea id="teamsInput" placeholder="Ejemplo: River Plate; CABA; *&#10;Boca Juniors; CABA"></textarea>
  <div>
    <label for="csvFile" class="btn">üìÑ Importar CSV</label>
    <input id="csvFile" type="file" accept=".csv,text/csv" style="display:none">
    <button class="btn" id="btnRender">Mostrar lista con checks</button>
    <button class="btn" id="btnRemove">‚ùå Eliminar seleccionados</button>
  </div>
  <div id="csvInfo" class="muted"></div>
  <ul id="teamsList"></ul>
</div>
<script>
// ---- Parser de l√≠neas manuales ----
function parseLine(line){
  const raw=line.replace(/\\t/g,',').trim();
  if(!raw) return null;
  let parts=raw.split(';');
  if(parts.length===1) parts=raw.split(',');
  parts=parts.map(s=>s.trim()).filter(Boolean);
  const name=parts[0]||'';
  const province=(parts[1]||'').replace(/\\*+$/,'').trim();
  let head=false;
  if(parts.length>=3){ head=/\\*|si|s√≠|head/i.test(parts[2]) }
  if(/\\*$/.test(name)){ head=true }
  return {name:name.replace(/\\*+$/,'').trim(), province, head};
}
function parseTeams(txt){
  return txt.split(/\\r?\\n/).map(parseLine).filter(t=>t&&t.name);
}

// ---- CSV robusto (delimitador auto , ; TAB + comillas + cabecera opcional) ----
function removeBOM(text){ if(text && text.charCodeAt(0)===0xFEFF) return text.slice(1); return text; }
function detectDelimiter(lines){
  const cand=[',',';','\\t'];
  const score={',':0,';':0,'\\t':0};
  const L=Math.min(lines.length,5);
  for(let i=0;i<L;i++){
    const s=lines[i];
    cand.forEach(d=>{ score[d]+= (s.match(new RegExp(d==='\\t'?'\\t':d,'g'))||[]).length; });
  }
  let best=','; let max=-1;
  for(const d of cand){ if(score[d]>max){max=score[d]; best=d;} }
  return max>0 ? best : ',';
}
function splitQuoted(line,delim){
  const out=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(ch==='\"'){
      if(inQ && line[i+1]==='\"'){ cur+='\"'; i++; }
      else { inQ=!inQ; }
    }else if(ch===delim && !inQ){
      out.push(cur); cur='';
    }else{
      cur+=ch;
    }
  }
  out.push(cur);
  return out.map(s=>s.trim());
}
function parseCSVText(text){
  text=removeBOM(text||'');
  const lines=text.split(/\\r?\\n/).filter(l=>l.trim().length>0);
  if(!lines.length) return [];
  const delim = detectDelimiter(lines);
  const dc = (delim==='\\t' ? '\\t' : delim);
  const header = splitQuoted(lines[0], dc);
  const hasHeader = header.some(v=>/^(equipo|team|nombre|provincia|province|regi[√≥o]n|cabeza|cabeza de serie|head|seed)$/i.test(v));
  let idx={name:0, province:1, head:2};
  if(hasHeader){
    // mapear columnas
    header.forEach((v,i)=>{
      const s=v.toLowerCase();
      if(/equipo|team|nombre/.test(s)) idx.name=i;
      if(/provincia|province|regi[√≥o]n/.test(s)) idx.province=i;
      if(/cabeza|cabeza de serie|head|seed/.test(s)) idx.head=i;
    });
  }
  const body = hasHeader ? lines.slice(1) : lines;
  const out=[];
  body.forEach(line=>{
    const p = splitQuoted(line, dc);
    let rawName = (p[idx.name]||'').trim();
    if(!rawName) return;
    const name = rawName.replace(/\\*+$/,'').trim();
    const province = (p[idx.province]||'').trim();
    const headRaw = (p[idx.head]||'').trim();
    const head = /^(si|s√≠|true|1|\\*|x|head|seed|cs)$/i.test(headRaw) || /\\*$/.test(rawName);
    out.push({name, province, head});
  });
  return {teams:out, delimiter: (dc==='\\t'?'TAB':dc), hasHeader};
}

// ---- UI ----
function renderList(){
  const ul=document.getElementById('teamsList');
  ul.innerHTML='';
  const teams=parseTeams(document.getElementById('teamsInput').value);
  teams.forEach((t,i)=>{
    const li=document.createElement('li');
    const chk=document.createElement('input'); chk.type='checkbox'; chk.dataset.index=i;
    const lbl=document.createElement('label'); lbl.textContent=t.name+(t.province?' ‚Äî '+t.province:'')+(t.head?' ‚òÖ':'');
    li.appendChild(chk); li.appendChild(lbl); ul.appendChild(li);
  });
  document.getElementById('csvInfo').textContent = teams.length ? (teams.length+' equipos cargados') : '';
}

document.getElementById('btnRender').addEventListener('click',renderList);
document.getElementById('btnRemove').addEventListener('click',()=>{
  const checks=[...document.querySelectorAll('#teamsList input[type=checkbox]:checked')];
  if(!checks.length){alert('No hay equipos seleccionados');return}
  let teams=parseTeams(document.getElementById('teamsInput').value);
  const idxs=new Set(checks.map(c=>parseInt(c.dataset.index)));
  teams = teams.filter((_,i)=>!idxs.has(i));
  document.getElementById('teamsInput').value = teams.map(t=>t.name+(t.province?'; '+t.province:'')+(t.head?'; *':'')).join('\n');
  renderList();
});

// Importar CSV (robusto)
document.getElementById('csvFile').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const parsed = parseCSVText(r.result);
      const arr = parsed.teams;
      if(!arr.length){ alert('No se detectaron equipos en el CSV'); return; }
      document.getElementById('teamsInput').value = arr.map(t=>t.name+(t.province?'; '+t.province:'')+(t.head?'; *':'')).join('\\n');
      document.getElementById('csvInfo').textContent = `CSV: ${arr.length} equipos ¬∑ Delimitador: ${parsed.delimiter}${parsed.hasHeader?' ¬∑ Con cabecera':''}`;
      renderList();
    }catch(err){
      console.error(err);
      alert('No se pudo leer el CSV. Us√° ",", ";" o TAB; columnas Equipo/Provincia/Cabeza (cabecera opcional).');
    }
  };
  r.readAsText(f,'utf-8');
});
</script>
</body>
</html>
