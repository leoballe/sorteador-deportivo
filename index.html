<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sorteador Deportivo</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--card:#1f2937;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent2:#38bdf8;--danger:#ef4444;--warn:#f59e0b}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    a{color:var(--accent2)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:clamp(22px,3vw,30px);margin:0}
    .badge{font-size:12px;background:#0b2;opacity:.9;padding:4px 8px;border-radius:999px}
    .panel{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #243042;border-radius:14px;padding:14px}
    .card h3{margin:0 0 8px 0;font-size:16px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=number],textarea,select{width:100%;background:#0b1220;color:var(--text);border:1px solid #223046;border-radius:10px;padding:10px;font-size:14px}
    textarea{min-height:200px;resize:vertical}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{background:#0b1220;color:var(--text);border:1px solid #223046;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn:hover{border-color:#3b82f6}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#16a34a);border:0;color:#052e16}
    .btn.ghost{background:transparent;border-color:#2b3b55}
    .btn.warn{background:linear-gradient(135deg,var(--warn),#d97706);border:0;color:#3b1d00}
    .tiny{font-size:12px;color:var(--muted)}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:10px;border:1px solid #223046;background:#0b1220;cursor:pointer}
    .tab.active{background:#0a3622;border-color:#1b5e3b}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
    .zone{background:#0b1220;border:1px solid #223046;border-radius:14px;padding:10px}
    .zone h4{margin:4px 0 8px 0}
    .zone ol{margin:0;padding-left:18px}
    .muted{color:var(--muted)}
    .warnText{color:var(--warn)}
    .errorText{color:var(--danger)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border:1px solid #2b3b55;border-radius:999px;background:#0b1220}
    .hidden{display:none}
    .history{display:grid;gap:8px}
    .history .item{background:#0b1220;border:1px dashed #2b3b55;padding:8px;border-radius:10px;font-size:13px}
    .listWrap{display:grid;grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:900px){.listWrap{grid-template-columns:1fr}}
    .listBox{background:#0b1220;border:1px dashed #2b3b55;border-radius:12px;padding:10px;min-height:120px}
    .listBox h4{margin:2px 0 8px 0;font-size:14px}
    .itemRow{display:flex;align-items:center;gap:8px;padding:4px 6px;border-bottom:1px dashed #1f2a3b}
    .itemRow:last-child{border-bottom:none}
    .tag{font-size:11px;color:#cbd5e1;border:1px solid #334155;border-radius:999px;padding:1px 6px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>üé≤ Sorteador Deportivo</h1>
        <div class="tiny">Funciona 100% en tu navegador (sin backend).</div>
      </div>
      <span class="badge">v1.9.0</span>
    </header>

    <div class="panel">
      <div class="tabs">
        <button class="tab active" data-tab="grupos" type="button">Zonas / Grupos</button>
        <button class="tab" data-tab="simple" type="button">Sorteo simple</button>
        <button class="tab" data-tab="bracket" type="button">Eliminaci√≥n directa (beta)</button>
      </div>

      <div id="tab-grupos" class="tabcontent">
        <div class="row">
          <div class="card">
            <h3>Equipos</h3>
            <label>Peg√° la lista (una l√≠nea por equipo). Opcional: <span class="pill">; Provincia</span> y <span class="pill">; *</span> para cabeza.</label>
            <textarea id="teamsInput" placeholder="Ejemplos:
River Plate; CABA; *
Boca Juniors; CABA
Newell's; Santa Fe
..."></textarea>
            <div class="controls" style="margin-top:8px">
              <label for="csvFile" class="btn ghost">üìÑ Importar CSV de equipos</label>
              <input id="csvFile" type="file" accept=".csv,text/csv" class="hidden" />
              <button class="btn ghost" id="btnExample" type="button">Cargar ejemplo</button>
              <button class="btn ghost" id="btnClear" type="button">Limpiar</button>
              <button class="btn" id="btnBuildList" type="button">üóÇÔ∏è Mostrar lista con checks</button>
            </div>
            <div class="tiny">CSV de equipos: <b>Equipo, Provincia, Cabeza</b> ("s√≠" para cabeza). Acepta <b>,</b>, <b>;</b> o <b>TAB</b>, con o sin cabecera.</div>
            <div id="csvInfo" class="tiny" style="margin-top:6px"></div>

            <div id="checkLists" class="listWrap hidden" style="margin-top:10px">
              <div class="listBox">
                <h4>Activos (participan) <span class="tag" id="countActive">0</span></h4>
                <div class="controls" style="margin-bottom:6px">
                  <button class="btn tiny" id="btnSelectAllActive" type="button">Seleccionar todo</button>
                  <button class="btn warn tiny" id="btnMoveToInactive" type="button">Descartar seleccionados ‚ûú</button>
                </div>
                <div id="activeList"></div>
              </div>
              <div class="listBox">
                <h4>Descartados <span class="tag" id="countInactive">0</span></h4>
                <div class="controls" style="margin-bottom:6px">
                  <label class="pill"><input type="checkbox" id="toggleShowInactive"> Mostrar descartados</label>
                  <button class="btn tiny" id="btnSelectAllInactive" type="button">Seleccionar todo</button>
                  <button class="btn primary tiny" id="btnRestoreSelected" type="button">‚¨Ö Restaurar seleccionados</button>
                </div>
                <div id="inactiveList" class="hidden"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Par√°metros</h3>
            <div class="controls" id="formatRow">
              <label class="pill"><input type="radio" name="format" value="8x3" checked> 8 zonas de 3</label>
              <label class="pill"><input type="radio" name="format" value="4x6"> 4 zonas de 6</label>
              <label class="pill"><input type="radio" name="format" value="custom"> Personalizado</label>
            </div>
            <div class="controls">
              <div style="min-width:140px;flex:1">
                <label>N¬∫ de zonas / grupos</label>
                <input type="number" id="zones" min="1" value="8" />
              </div>
              <div style="min-width:180px;flex:1">
                <label>Disciplina</label>
                <select id="disciplineSelect" disabled>
                  <option value="">‚Äî Carg√° CSV de disciplinas ‚Äî</option>
                </select>
              </div>
              <div style="min-width:180px;flex:1">
                <label>Categor√≠a</label>
                <select id="categorySelect" disabled>
                  <option value="">‚Äî Carg√° CSV de categor√≠as ‚Äî</option>
                </select>
              </div>
              <div style="min-width:160px;flex:1">
                <label>G√©nero</label>
                <select id="genderSelect">
                  <option value="No Aplica" selected>No Aplica</option>
                  <option value="Masculino">Masculino</option>
                  <option value="Femenino">Femenino</option>
                  <option value="Mixto">Mixto</option>
                </select>
              </div>
            </div>
            <div class="controls">
              <label for="csvDisciplines" class="btn ghost">üìÑ Importar CSV de disciplinas</label>
              <input id="csvDisciplines" type="file" accept=".csv,text/csv" class="hidden" />
              <button class="btn ghost" id="btnDiscDemo" type="button">Cargar disciplinas demo</button>

              <label for="csvCategories" class="btn ghost">üìÑ Importar CSV de categor√≠as</label>
              <input id="csvCategories" type="file" accept=".csv,text/csv" class="hidden" />
              <button class="btn ghost" id="btnCatDemo" type="button">Cargar categor√≠as demo</button>
            </div>
            <div id="discCSVInfo" class="tiny" style="margin-top:4px"></div>
            <div id="catCSVInfo" class="tiny" style="margin-top:4px"></div>

            <label><input type="checkbox" id="headsAsFirst" checked> Cabezas de serie primero</label>
            <div id="capInfo" class="tiny" style="margin-top:6px"></div>

            <div class="controls" style="margin-top:10px">
              <button class="btn primary" id="btnDrawGroups" type="button">üéØ SORTEAR ZONAS</button>
              <button class="btn" id="btnExportCSV" type="button">‚¨áÔ∏è Exportar CSV</button>
              <button class="btn" id="btnCopy" type="button">üìã Copiar</button>
              <button class="btn" id="btnShare" type="button">üîó Compartir</button>
              <button class="btn" id="btnExportPDF" type="button">üñ®Ô∏è Exportar PDF</button>
            </div>
            <div id="status" class="tiny" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Resultado</h3>
          <div id="resultGroups" class="grid"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Historial (local)</h3>
          <div class="history" id="history"></div>
        </div>
      </div>

      <div id="tab-simple" class="tabcontent hidden">
        <div class="row">
          <div class="card">
            <h3>Equipos</h3>
            <label>Usa la lista del tab Grupos (o peg√° otra):</label>
            <textarea id="simpleInput" placeholder="Uno por l√≠nea..."></textarea>
            <div class="controls" style="margin-top:8px">
              <button class="btn ghost" id="btnUseFromGroups" type="button">Usar lista del tab Grupos</button>
              <button class="btn ghost" id="btnClearSimple" type="button">Limpiar</button>
            </div>
          </div>
          <div class="card">
            <h3>Par√°metros</h3>
            <div class="controls">
              <div style="min-width:180px;flex:1">
                <label>Disciplina</label>
                <select id="disciplineSelectSimple" disabled>
                  <option value="">‚Äî Carg√° CSV de disciplinas ‚Äî</option>
                </select>
              </div>
              <div style="min-width:180px;flex:1">
                <label>Categor√≠a</label>
                <select id="categorySelectSimple" disabled>
                  <option value="">‚Äî Carg√° CSV de categor√≠as ‚Äî</option>
                </select>
              </div>
              <div style="min-width:160px;flex:1">
                <label>G√©nero</label>
                <select id="genderSelectSimple">
                  <option value="No Aplica" selected>No Aplica</option>
                  <option value="Masculino">Masculino</option>
                  <option value="Femenino">Femenino</option>
                  <option value="Mixto">Mixto</option>
                </select>
              </div>
            </div>
            <div class="controls" style="margin-top:10px">
              <button class="btn primary" id="btnDrawSimple" type="button">üé≤ SORTEAR ORDEN</button>
              <button class="btn" id="btnExportSimple" type="button">‚¨áÔ∏è Exportar CSV</button>
              <button class="btn" id="btnCopySimple" type="button">üìã Copiar</button>
            </div>
            <div id="statusSimple" class="tiny" style="margin-top:8px"></div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>Resultado</h3>
          <div id="resultSimple"></div>
        </div>
      </div>

      <div id="tab-bracket" class="tabcontent hidden">
        <div class="row">
          <div class="card">
            <h3>Equipos</h3>
            <label>Usa la lista del tab Grupos (o peg√° otra):</label>
            <textarea id="bracketInput" placeholder="Uno por l√≠nea..."></textarea>
            <div class="controls" style="margin-top:8px">
              <button class="btn ghost" id="btnUseFromGroups2" type="button">Usar lista del tab Grupos</button>
              <button class="btn ghost" id="btnClearBracket" type="button">Limpiar</button>
            </div>
          </div>
          <div class="card">
            <h3>Par√°metros</h3>
            <div class="controls">
              <div style="min-width:180px;flex:1">
                <label>Disciplina</label>
                <select id="disciplineSelectBracket" disabled>
                  <option value="">‚Äî Carg√° CSV de disciplinas ‚Äî</option>
                </select>
              </div>
              <div style="min-width:180px;flex:1">
                <label>Categor√≠a</label>
                <select id="categorySelectBracket" disabled>
                  <option value="">‚Äî Carg√° CSV de categor√≠as ‚Äî</option>
                </select>
              </div>
              <div style="min-width:160px;flex:1">
                <label>G√©nero</label>
                <select id="genderSelectBracket">
                  <option value="No Aplica" selected>No Aplica</option>
                  <option value="Masculino">Masculino</option>
                  <option value="Femenino">Femenino</option>
                  <option value="Mixto">Mixto</option>
                </select>
              </div>
            </div>
            <div class="controls" style="margin-top:10px">
              <button class="btn primary" id="btnDrawBracket" type="button">ü•ä Generar llaves</button>
              <button class="btn" id="btnExportBracket" type="button">‚¨áÔ∏è Exportar CSV</button>
              <div class="tiny">Si el n¬∫ de equipos no es potencia de 2, se completa con BYE.</div>
            </div>
            <div id="statusBracket" class="tiny" style="margin-top:8px"></div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>Resultado</h3>
          <div id="resultBracket" class="grid"></div>
        </div>
      </div>
    </div>

    <div class="tiny" style="margin-top:12px">Hecho con ‚ù§Ô∏è. Todo ocurre del lado del cliente (no se sube nada). Pod√©s guardar y compartir con ‚Äúüîó Compartir‚Äù.</div>
  </div>

<script>
'use strict';

/* ====================== RNG y utils ====================== */
function xmur3(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19;}return function(){h=Math.imul(h^h>>>16,2246822507);h=Math.imul(h^h>>>13,3266489909);return (h^h>>>16)>>>0}}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
function rngFromSeed(seed){if(!seed||seed.trim()===""){return Math.random}else{const h=xmur3(String(seed))();return mulberry32(h)}}
function shuffle(array, rand){const a=array.slice();for(let i=a.length-1;i>0;i++){const j=Math.floor(rand()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function escapeHtml(s){return s.replace(/[&<>"]/g,c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\\"":"&quot;"}[c]))}

/* ====================== Parseo equipos ====================== */
function parseLine(line){
  const raw=line.replace(/\\t/g,',').trim();
  if(!raw) return null;
  let parts=raw.split(';'); if(parts.length===1) parts=raw.split(',');
  parts=parts.map(s=>s.trim()).filter(Boolean);
  const name=parts[0]||'';
  const province=(parts[1]||'').replace(/\\*+$/,'').trim();
  let head=false;
  if(parts.length>=3){head=/\\*|si|s√≠|head/i.test(parts[2])}
  if(/\\*$/.test(name)){head=true}
  return {name:name.replace(/\\*+$/,'').trim(), province, head};
}
function parseText(value){
  const lines=value.split(/\\r?\\n/);
  const teams=[];
  for(const line of lines){const t=parseLine(line); if(t&&t.name) teams.push(t)}
  return teams;
}

/* ====================== CSV equipos ====================== */
function importCSVTeams(text){
  if(text && text.charCodeAt(0)===0xFEFF){ text=text.slice(1) } // BOM
  const lines = text.split(/\\r?\\n/).filter(l=>l.trim().length>0);
  if(!lines.length) return {list:[], delim:','};

  const sample = lines[0];
  const cntComma = (sample.match(/,/g)||[]).length;
  const cntSemi  = (sample.match(/;/g)||[]).length;
  const cntTab   = (sample.match(/\\t/g)||[]).length;
  let delim = ',';
  if(cntTab>=cntComma && cntTab>=cntSemi && cntTab>0) delim = '\\t';
  else if(cntSemi>=cntComma && cntSemi>0) delim = ';';
  else if(cntComma>0) delim = ',';

  function splitQuoted(line){
    const out=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){
        if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else { inQ=!inQ; }
      } else if(ch===delim && !inQ){
        out.push(cur); cur='';
      } else {
        cur+=ch;
      }
    }
    out.push(cur);
    return out.map(s=> s.trim());
  }

  const headRow = splitQuoted(lines[0]);
  const hasHeader = headRow.some(v=>/^(equipo|team|nombre|provincia|province|regi[√≥o]n|cabeza|cabeza de serie|head|seed)$/i.test(v));

  let idx = { name:0, province:1, head:2 };
  if(hasHeader){
    headRow.forEach((v,i)=>{
      const s=v.toLowerCase();
      if(/equipo|team|nombre/.test(s)) idx.name=i;
      if(/provincia|province|regi[√≥o]n/.test(s)) idx.province=i;
      if(/cabeza|cabeza de serie|head|seed/.test(s)) idx.head=i;
    });
  }

  const body = hasHeader? lines.slice(1) : lines;
  const out=[];
  for(const line of body){
    const parts=splitQuoted(line);
    let rawName=(parts[idx.name]||''); if(rawName && rawName.charCodeAt(0)===0xFEFF){ rawName=rawName.slice(1) }
    rawName=rawName.trim(); if(!rawName) continue;
    const name=rawName.replace(/\\*+$/,'').trim();
    const province=(parts[idx.province]||'').trim();
    const headRaw=(parts[idx.head]||'').trim();
    const head=/^(si|s√≠|true|1|\\*|x|head|seed|cs)$/i.test(headRaw) || /\\*$/.test(rawName);
    out.push({name, province, head});
  }
  return {list:out, delim};
}

/* ====================== CSV disciplinas y categor√≠as ====================== */
let disciplines = []; // {name, seed?}
let categories = [];  // {name, code?}

function importCSVDisciplines(text){
  if(text && text.charCodeAt(0)===0xFEFF){ text=text.slice(1) } // BOM
  const lines = text.split(/\\r?\\n/).filter(l=>l.trim().length>0);
  if(!lines.length) return {list:[], delim:','};

  const sample = lines[0];
  const cntComma = (sample.match(/,/g)||[]).length;
  const cntSemi  = (sample.match(/;/g)||[]).length;
  const cntTab   = (sample.match(/\\t/g)||[]).length;
  let delim = ',';
  if(cntTab>=cntComma && cntTab>=cntSemi && cntTab>0) delim = '\\t';
  else if(cntSemi>=cntComma && cntSemi>0) delim = ';';
  else if(cntComma>0) delim = ',';

  function splitQuoted(line){
    const out=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){
        if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else { inQ=!inQ; }
      } else if(ch===delim && !inQ){
        out.push(cur); cur='';
      } else {
        cur+=ch;
      }
    }
    out.push(cur);
    return out.map(s=> s.trim());
  }

  const headRow = splitQuoted(lines[0]);
  const hasHeader = headRow.some(v=>/^(disciplina|deporte|sport|nombre|semilla|seed|codigo|code)$/i.test(v));

  let idx = { name:0, seed:1 };
  if(hasHeader){
    headRow.forEach((v,i)=>{
      const s=v.toLowerCase();
      if(/^(disciplina|deporte|sport|nombre)$/.test(s)) idx.name=i;
      if(/^(semilla|seed|codigo|code)$/.test(s)) idx.seed=i;
    });
  }

  const body = hasHeader? lines.slice(1) : lines;
  const out=[];
  for(const line of body){
    const parts=splitQuoted(line);
    let rawName=(parts[idx.name]||''); if(rawName && rawName.charCodeAt(0)===0xFEFF){ rawName=rawName.slice(1) }
    rawName=rawName.trim(); if(!rawName) continue;
    const name=rawName;
    const seed=(parts[idx.seed]||'').trim();
    out.push({name, seed: seed||name});
  }
  return {list:out, delim};
}

function importCSVCategories(text){
  if(text && text.charCodeAt(0)===0xFEFF){ text=text.slice(1) } // BOM
  const lines = text.split(/\\r?\\n/).filter(l=>l.trim().length>0);
  if(!lines.length) return {list:[], delim:','};

  const sample = lines[0];
  const cntComma = (sample.match(/,/g)||[]).length;
  const cntSemi  = (sample.match(/;/g)||[]).length;
  const cntTab   = (sample.match(/\\t/g)||[]).length;
  let delim = ',';
  if(cntTab>=cntComma && cntTab>=cntSemi && cntTab>0) delim = '\\t';
  else if(cntSemi>=cntComma && cntSemi>0) delim = ';';
  else if(cntComma>0) delim = ',';

  function splitQuoted(line){
    const out=[]; let cur=''; let inQ=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){
        if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else { inQ=!inQ; }
      } else if(ch===delim && !inQ){
        out.push(cur); cur='';
      } else {
        cur+=ch;
      }
    }
    out.push(cur);
    return out.map(s=> s.trim());
  }

  const headRow = splitQuoted(lines[0]);
  const hasHeader = headRow.some(v=>/^(categor√≠a|categoria|category|nombre|codigo|code)$/i.test(v));

  let idx = { name:0, code:1 };
  if(hasHeader){
    headRow.forEach((v,i)=>{
      const s=v.toLowerCase();
      if(/^(categor√≠a|categoria|category|nombre)$/.test(s)) idx.name=i;
      if(/^(codigo|code)$/.test(s)) idx.code=i;
    });
  }

  const body = hasHeader? lines.slice(1) : lines;
  const out=[];
  for(const line of body){
    const parts=splitQuoted(line);
    let rawName=(parts[idx.name]||''); if(rawName && rawName.charCodeAt(0)===0xFEFF){ rawName=rawName.slice(1) }
    rawName=rawName.trim(); if(!rawName) continue;
    const name=rawName;
    const code=(parts[idx.code]||'').trim();
    out.push({name, code: code||name});
  }
  return {list:out, delim};
}

function refreshDisciplineSelects(){
  const sels=[document.getElementById('disciplineSelect'),
              document.getElementById('disciplineSelectSimple'),
              document.getElementById('disciplineSelectBracket')];
  sels.forEach(sel=>{
    sel.innerHTML='';
    if(disciplines.length===0){
      const opt=document.createElement('option'); opt.value=''; opt.textContent='‚Äî Carg√° CSV de disciplinas ‚Äî'; sel.appendChild(opt); sel.disabled=true;
    }else{
      const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='‚Äî Seleccionar disciplina ‚Äî'; sel.appendChild(opt0);
      disciplines.forEach(d=>{
        const o=document.createElement('option'); o.value=d.name; o.textContent=d.name; o.dataset.seed=d.seed||d.name;
        sel.appendChild(o);
      });
      sel.disabled=false;
    }
  });
}

function refreshCategorySelects(){
  const sels=[document.getElementById('categorySelect'),
              document.getElementById('categorySelectSimple'),
              document.getElementById('categorySelectBracket')];
  sels.forEach(sel=>{
    sel.innerHTML='';
    if(categories.length===0){
      const opt=document.createElement('option'); opt.value=''; opt.textContent='‚Äî Carg√° CSV de categor√≠as ‚Äî'; sel.appendChild(opt); sel.disabled=true;
    }else{
      const opt0=document.createElement('option'); opt0.value=''; opt0.textContent='‚Äî Seleccionar categor√≠a ‚Äî'; sel.appendChild(opt0);
      categories.forEach(d=>{
        const o=document.createElement('option'); o.value=d.name; o.textContent=d.name; o.dataset.code=d.code||d.name;
        sel.appendChild(o);
      });
      sel.disabled=false;
    }
  });
}

function getSelectedDisciplineName(){
  const sel=document.getElementById('disciplineSelect');
  if(!sel) return '';
  const val=sel.value || '';
  return val;
}
function getSelectedDisciplineSeed(){
  const sel=document.getElementById('disciplineSelect');
  if(!sel) return '';
  const opt=sel.selectedOptions[0];
  if(opt && opt.dataset && opt.dataset.seed){ return opt.dataset.seed }
  const name=sel.value||'';
  return name;
}
function setSelectedDisciplineByName(name){
  [document.getElementById('disciplineSelect'),
   document.getElementById('disciplineSelectSimple'),
   document.getElementById('disciplineSelectBracket')].forEach(sel=>{
     if(!sel) return;
     const options=Array.from(sel.options);
     const found=options.find(o=>o.value===name);
     if(found){ sel.value=name; }
     else if(name){
       const o=document.createElement('option'); o.value=name; o.textContent=name; o.dataset.seed=name;
       sel.appendChild(o); sel.value=name; sel.disabled=false;
     }
   });
}

function getSelectedCategoryName(){
  const sel=document.getElementById('categorySelect');
  if(!sel) return '';
  return sel.value || '';
}
function setSelectedCategoryByName(name){
  [document.getElementById('categorySelect'),
   document.getElementById('categorySelectSimple'),
   document.getElementById('categorySelectBracket')].forEach(sel=>{
     if(!sel) return;
     const options=Array.from(sel.options);
     const found=options.find(o=>o.value===name);
     if(found){ sel.value=name; }
     else if(name){
       const o=document.createElement('option'); o.value=name; o.textContent=name; o.dataset.code=name;
       sel.appendChild(o); sel.value=name; sel.disabled=false;
     }
   });
}
function getSelectedGender(){
  const sel=document.getElementById('genderSelect');
  return sel ? (sel.value||'') : '';
}

/* ====================== Capacidades ====================== */
function capacities(n,z){const base=Math.floor(n/z),rest=n%z;return Array.from({length:z},(_,i)=>base+(i<rest?1:0))}
function capacitiesFourBySix(n){const caps=[6,6,6,6];const total=24;if(n>=total) return caps;let deficits=total-n;const order=[3,1,2,0];let i=0;while(deficits>0){const idx=order[i%order.length];if(caps[idx]>0){caps[idx]--;deficits--}i++}return caps}
function capacitiesEightByThree(n){const caps=Array(8).fill(3);const total=24;if(n>=total) return caps;const d=total-n;const zeros=Math.floor(d/3);const twos=d%3;const order=[7,6,5,4,3,2,1,0];for(let i=0;i<zeros;i++){caps[order[i]]=0}let k=zeros;for(let j=0;j<twos && k<order.length;j++,k++){if(caps[order[k]]===3) caps[order[k]]=2}return caps}

/* ====================== Restricciones y sorteo ====================== */
// Eliminado el bloqueo por provincia: canPlace siempre devuelve true.
function canPlace(team,group){return true}
function placeHeads(groups,heads){for(let i=0;i<groups.length && i<heads.length;i++){groups[i].push(heads[i])}}
function penalty(arr){const seen={};let p=0;for(const t of arr){if(!t.province) continue;const k=t.province.toLowerCase();seen[k]=(seen[k]||0)+1}for(const k in seen){if(seen[k]>1) p+=seen[k]-1}return p}

function drawGroups(teams,z,seed,headsAsFirst,format){
  const rand=rngFromSeed(seed);
  const n=teams.length;
  if(z<1) return {error:'El n¬∫ de zonas debe ser ‚â• 1'};
  if(n<z) return {error:'Hay menos equipos que zonas.'};

  const capsBase=(format==='4x6'&&z===4&&n<=24)?capacitiesFourBySix(n):(format==='8x3'&&z===8&&n<=24?capacitiesEightByThree(n):capacities(n,z));
  const groups=Array.from({length:z},()=>[]);

  const heads=shuffle(teams.filter(t=>t.head),rand);
  const others=shuffle(teams.filter(t=>!t.head),rand);
  if(headsAsFirst&&heads.length){placeHeads(groups,heads)}

  const targetCaps=capsBase.slice();
  for(let i=0;i<groups.length;i++){targetCaps[i]=Math.max(0,targetCaps[i]-groups[i].length)}

  const pool=headsAsFirst?others:shuffle(teams,rand);
  const maxAttempts=600; let best=null;
  for(let attempt=0;attempt<maxAttempts;attempt++){
    const g=groups.map(a=>a.slice()); const remaining=targetCaps.slice(); let ok=true;
    const order=shuffle(pool,rand);
    for(const team of order){
      const candidates=g.map((arr,idx)=>({idx,size:arr.length,cap:remaining[idx]})).filter(x=>x.cap>0).sort((a,b)=>a.size-b.size||a.idx-b.idx).map(x=>x.idx);
      let placed=false;
      for(const idx of candidates){ if(canPlace(team,g[idx])){ g[idx].push(team); remaining[idx]--; placed=true; break; } }
      if(!placed && candidates.length){ const pick=candidates[Math.floor(rand()*candidates.length)]; g[pick].push(team); remaining[pick]--; placed=true; }
      if(!placed){ ok=false; break; }
    }
    if(ok){ return {groups:g,caps:capsBase,relaxed:false,attempt}; }
    const score=g.reduce((acc,arr)=> acc + penalty(arr),0);
    if(!best || score<best.score){ best={groups:g,caps:capsBase,relaxed:true,score} }
  }
  return best||{error:'No se pudo asignar. Prob√° sin restricciones.'};
}

/* ====================== Export y helpers ====================== */
function renderGroups(target,result){
  if(result.error){ target.innerHTML='<div class="errorText">'+result.error+'</div>'; return }
  const {groups} = result;
  const grid=document.createElement('div'); grid.className='grid';
  groups.forEach((arr,gi)=>{
    const card=document.createElement('div'); card.className='zone';
    const warn=penalty(arr)>0?' <span class="warnText" title="Puede haber provincias repetidas">‚ö†</span>':'';
    card.innerHTML='<h4>Zona '+(gi+1)+warn+'</h4>';
    const ol=document.createElement('ol');
    arr.forEach(t=>{
      const li=document.createElement('li');
      li.innerHTML='<b>'+escapeHtml(t.name)+'</b>'+(t.province?' <span class="muted">‚Äî '+escapeHtml(t.province)+'</span>':'')+(t.head?' <span class="pill">Cabeza</span>':'');
      ol.appendChild(li);
    });
    card.appendChild(ol); grid.appendChild(card);
  });
  target.innerHTML=''; target.appendChild(grid);
  document.getElementById('status').innerHTML='Sorteo realizado';
}

function exportGroupsCSV(groups){
  let csv='Zona,Posicion,Equipo,Provincia,Cabeza\\n';
  groups.forEach((arr,gi)=>{
    arr.forEach((t,i)=>{
      csv+=(gi+1)+','+(i+1)+',\"'+t.name.replace(/\"/g,'\"\"')+'\"'+(t.province?',\"'+t.province.replace(/\"/g,'\"\"')+'\"':',')+(t.head?',si':',no')+'\\n';
    });
  });
  downloadText(csv,'sorteo_zonas.csv');
}
function exportSimpleCSV(list){
  let csv='Posicion,Equipo\\n';
  list.forEach((n,i)=>{ csv+=(i+1)+',\"'+n.replace(/\"/g,'\"\"')+'\"\\n' });
  downloadText(csv,'sorteo_simple.csv');
}
function exportBracketCSV(matches){
  let csv='Llave,Partido,Equipo A,Equipo B\\n';
  matches.forEach((m,i)=>{ csv+='Ronda 1,'+(i+1)+',\"'+m[0]+'\",\"'+m[1]+'\"\\n' });
  downloadText(csv,'llaves.csv');
}
function downloadText(text,filename){
  const blob=new Blob([text],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}
function copyText(text){
  navigator.clipboard.writeText(text).then(()=>{toast('Copiado')}).catch(()=>alert('No se pudo copiar'))
}
function toast(msg){
  const el=document.createElement('div');
  el.textContent=msg; el.style.position='fixed'; el.style.bottom='16px'; el.style.right='16px'; el.style.background='#111827'; el.style.border='1px solid #334155'; el.style.padding='10px 12px'; el.style.borderRadius='10px'; el.style.zIndex=9999;
  document.body.appendChild(el); setTimeout(()=>el.remove(),1500);
}

/* ====================== Estado, listas activas/inactivas ====================== */
let activeTeams=[], inactiveTeams=[];

// Construye listas desde el textarea (resetea descartados)
function buildListsFromTextarea(){
  activeTeams = parseText(document.getElementById('teamsInput').value);
  inactiveTeams = [];
  document.getElementById('checkLists').classList.remove('hidden');
  renderLists(); updateCapInfo();
}
function renderLists(){
  const aBox=document.getElementById('activeList');
  const iBox=document.getElementById('inactiveList');
  const showInactive=document.getElementById('toggleShowInactive').checked;

  document.getElementById('countActive').textContent = activeTeams.length;
  document.getElementById('countInactive').textContent = inactiveTeams.length;

  iBox.classList.toggle('hidden', !showInactive);

  aBox.innerHTML='';
  activeTeams.forEach((t,idx)=>{
    const row=document.createElement('div'); row.className='itemRow';
    row.innerHTML = '<input type=\"checkbox\" class=\"chkActive\" data-idx=\"'+idx+'\"> <b>'+escapeHtml(t.name)+'</b>'+(t.province? ' <span class=\"muted\">‚Äî '+escapeHtml(t.province)+'</span>':'')+(t.head? ' <span class=\"pill\">Cabeza</span>':'');
    aBox.appendChild(row);
  });
  iBox.innerHTML='';
  inactiveTeams.forEach((t,idx)=>{
    const row=document.createElement('div'); row.className='itemRow';
    row.innerHTML = '<input type=\"checkbox\" class=\"chkInactive\" data-idx=\"'+idx+'\"> <b>'+escapeHtml(t.name)+'</b>'+(t.province? ' <span class=\"muted\">‚Äî '+escapeHtml(t.province)+'</span>':'')+(t.head? ' <span class=\"pill\">Cabeza</span>':'');
    iBox.appendChild(row);
  });
}
function getChecked(selector){
  return Array.from(document.querySelectorAll(selector+':checked')).map(el=> parseInt(el.getAttribute('data-idx'),10)).filter(n=>!isNaN(n));
}
function moveSelectedToInactive(){
  const idxs=getChecked('.chkActive').sort((a,b)=>b-a);
  const moved=[];
  idxs.forEach(i=>{ if(activeTeams[i]) moved.push(activeTeams.splice(i,1)[0]); });
  inactiveTeams = moved.concat(inactiveTeams);
  renderLists(); updateCapInfo();
}
function restoreSelectedFromInactive(){
  const idxs=getChecked('.chkInactive').sort((a,b)=>b-a);
  const moved=[];
  idxs.forEach(i=>{ if(inactiveTeams[i]) moved.push(inactiveTeams.splice(i,1)[0]); });
  activeTeams = activeTeams.concat(moved);
  renderLists(); updateCapInfo();
}
function selectAll(selector){ document.querySelectorAll(selector).forEach(el=>{ el.checked=true }) }

// Activos "en vivo": si el panel de checks est√° oculto, usar textarea directamente (no obliga a abrir el panel)
function getActiveTeamsLive(){
  const panelVisible = !document.getElementById('checkLists').classList.contains('hidden');
  if(panelVisible) return activeTeams.slice();
  return parseText(document.getElementById('teamsInput').value);
}

/* ====================== Compartir estado ====================== */
function getFormat(){const r=document.querySelector('input[name=\"format\"]:checked');return r?r.value:'custom'}
function currentZones(){
  const fmt=getFormat();
  if(fmt==='8x3') return 8;
  if(fmt==='4x6') return 4;
  return parseInt(document.getElementById('zones').value,10)||1;
}
function gatherState(){
  return {teams:activeTeams, inactive:inactiveTeams, z:currentZones(), headsAsFirst:document.getElementById('headsAsFirst').checked, discipline:getSelectedDisciplineName(), disciplineSeed:getSelectedDisciplineSeed(), category:getSelectedCategoryName(), gender:getSelectedGender(), format:getFormat()}
}
function loadStateToUI(st){
  if(st.teams){ activeTeams = st.teams }
  if(st.inactive){ inactiveTeams = st.inactive }
  document.getElementById('teamsInput').value = activeTeams.concat(inactiveTeams).map(t=> t.name+(t.province?'; '+t.province:'')+(t.head?'; *':'')).join('\\n');
  if(st.z) document.getElementById('zones').value=st.z;
  if(st.format) setFormat(st.format);
  if(st.discipline){ setSelectedDisciplineByName(st.discipline) }
  if(st.category){ setSelectedCategoryByName(st.category) }
  if(st.gender){ const g=document.getElementById('genderSelect'); if(g) g.value=st.gender; }
  document.getElementById('checkLists').classList.remove('hidden');
  renderLists(); updateCapInfo();
}
function encodeState(st){const json=JSON.stringify(st);return btoa(unescape(encodeURIComponent(json)))}
function decodeState(b64){try{const json=decodeURIComponent(escape(atob(b64)));return JSON.parse(json)}catch(e){return null}}
function setShareLink(){const st=gatherState();const hash=encodeState(st);const url=location.origin+location.pathname+'#'+hash;copyText(url)}
function tryLoadFromHash(){if(location.hash&&location.hash.length>1){const st=decodeState(location.hash.slice(1));if(st){loadStateToUI(st);toast('Estado restaurado')}}}

/* ====================== PDF (A4) ====================== */
async function exportPDF(){
  try{
    if(!(window.jspdf&&window.html2canvas)){alert('No se pudieron cargar las librer√≠as de PDF (jsPDF/html2canvas).');return}
    const teams = getActiveTeamsLive(); if(!teams.length){ toast('No hay equipos activos'); return }
    const z=currentZones();
    const headsAsFirst=document.getElementById('headsAsFirst').checked;
    const seed=getSelectedDisciplineSeed();
    const fmt=getFormat();
    const res=drawGroups(teams,z,seed,headsAsFirst,fmt);
    if(res.error){toast('Gener√° el sorteo primero');return}

    const sheet=document.createElement('div');
    sheet.style.width='794px';sheet.style.height='1123px';sheet.style.background='#ffffff';sheet.style.color='#0f172a';
    sheet.style.position='fixed';sheet.style.left='-9999px';sheet.style.top='0';sheet.style.display='flex';sheet.style.flexDirection='column';
    sheet.style.fontFamily='Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif';
    const bar=document.createElement('div');bar.style.height='8px';bar.style.background='linear-gradient(90deg,#22c55e,#38bdf8)';sheet.appendChild(bar);
    const header=document.createElement('div');header.style.display='flex';header.style.justifyContent='space-between';header.style.alignItems='center';header.style.padding='12px 16px 8px';
    const title=document.createElement('div');title.style.fontSize='22px';title.style.fontWeight='600';title.textContent='Sorteo de Zonas';const right=document.createElement('div');right.style.textAlign='right';right.style.fontSize='11px';right.innerHTML='Equipos: <b>'+teams.length+'</b><br>'+new Date().toLocaleString();
    header.appendChild(title);header.appendChild(right);sheet.appendChild(header);
    const chips=document.createElement('div');chips.style.display='flex';chips.style.flexWrap='wrap';chips.style.gap='6px';chips.style.margin='2px 16px 10px';
    function chip(txt){const s=document.createElement('span');s.textContent=txt;s.style.fontSize='11px';s.style.padding='4px 8px';s.style.border='1px solid #e2e8f0';s.style.borderRadius='500px';s.style.background='#f8fafc';return s}
    const fmtTxt=(fmt==='8x3'?'Formato: 8√ó3':(fmt==='4x6'?'Formato: 4√ó6':'Zonas: '+z)); chips.appendChild(chip(fmtTxt));
    const discName=getSelectedDisciplineName(); if(discName) chips.appendChild(chip('Disciplina: '+discName));
    const catName=getSelectedCategoryName(); if(catName) chips.appendChild(chip('Categor√≠a: '+catName));
    const gen=getSelectedGender(); if(gen) chips.appendChild(chip('G√©nero: '+gen));
    sheet.appendChild(chips);
    const grid=document.createElement('div');grid.style.display='grid';const cols=(res.groups.length>=6)?4:2;grid.style.gridTemplateColumns='repeat('+cols+',1fr)';grid.style.gap='10px';grid.style.padding='0 12px';grid.style.flex='0';
    res.groups.forEach((arr,gi)=>{const card=document.createElement('div');card.style.border='1px solid #e2e8f0';card.style.borderRadius='12px';card.style.background='#ffffff';card.style.boxShadow='0 1px 0 rgba(0,0,0,.04)';
      const head=document.createElement('div');head.style.display='flex';head.style.justifyContent='space-between';head.style.alignItems='center';head.style.padding='6px 10px';head.style.background='linear-gradient(90deg, rgba(34,197,94,.08), rgba(56,189,248,.08))';head.style.borderTopLeftRadius='12px';head.style.borderTopRightRadius='12px';
      const hleft=document.createElement('div');hleft.style.fontWeight='800';hleft.style.fontSize='18px';hleft.textContent='Zona '+(gi+1);
      head.appendChild(hleft);card.appendChild(head);
      const body=document.createElement('div');body.style.padding='8px 12px 10px';body.style.textAlign='center';const ol=document.createElement('ol');ol.style.margin='0';ol.style.paddingLeft='8px';ol.style.listStylePosition='inside';ol.style.fontSize='18px';ol.style.lineHeight='1.35';
      arr.forEach(t=>{const li=document.createElement('li');li.textContent=t.name+(t.province?' ‚Äî '+t.province:'')+(t.head?' ‚òÖ':'');ol.appendChild(li)}); body.appendChild(ol); card.appendChild(body); grid.appendChild(card);
    });
    sheet.appendChild(grid);
    const footer=document.createElement('div');footer.style.fontSize='10px';footer.style.color='#64748b';footer.style.textAlign='right';footer.style.padding='4px 12px 10px';footer.textContent='Generado con Sorteador Deportivo ‚Äî '+(location.href.split('#')[0]||'');sheet.appendChild(footer);
    document.body.appendChild(sheet);
    await new Promise(r=>setTimeout(r,20));
    const canvas=await html2canvas(sheet,{backgroundColor:'#ffffff',scale:2,useCORS:true});
    const img=canvas.toDataURL('image/png'); document.body.removeChild(sheet);
    const { jsPDF }=window.jspdf; const pdf=new jsPDF({orientation:'portrait',unit:'pt',format:'a4'});
    const pw=pdf.internal.pageSize.getWidth(); const ph=pdf.internal.pageSize.getHeight();
    pdf.addImage(img,'PNG',0,0,pw,ph); const dateStr=new Date().toISOString().slice(0,10); pdf.save('sorteo_'+dateStr+'.pdf');
  }catch(err){ console.error(err); alert('No se pudo exportar el PDF.'); }
}

/* ============ Abrir resultado en pesta√±a nueva ============ */
function openResultInNewTab(result){
  if(result.error) return;
  const disc=getSelectedDisciplineName();
  const cat=getSelectedCategoryName();
  const gen=getSelectedGender();
  const titleParts=[]; if(disc) titleParts.push(disc); if(cat) titleParts.push(cat); if(gen) titleParts.push(gen);
  const win = window.open('', '_blank', 'noopener,noreferrer');
  if(!win){ toast('El navegador bloque√≥ la ventana emergente'); return; }
  const head = `
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Resultado de Sorteo${titleParts.length?(' ‚Äî '+titleParts.join(' ¬∑ ')) : ''}</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:0;padding:24px;background:#0f172a;color:#e5e7eb}
      h1{margin:0 0 12px 0;font-size:22px}
      .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
      .zone{background:#0b1220;border:1px solid #223046;border-radius:12px}
      .zone h4{margin:0;padding:8px 10px;background:linear-gradient(90deg, rgba(34,197,94,.08), rgba(56,189,248,.08));border-top-left-radius:12px;border-top-right-radius:12px}
      .zone ol{margin:8px 0 12px 0;padding-left:24px}
      .muted{color:#94a3b8}
      .pill{display:inline-block;border:1px solid #2b3b55;border-radius:999px;padding:1px 6px;font-size:11px;margin-left:6px}
      .warn{color:#f59e0b}
    </style>`;
  let chips = [];
  if(disc) chips.push(`Disciplina: <b>${disc}</b>`);
  if(cat)  chips.push(`Categor√≠a: <b>${cat}</b>`);
  if(gen)  chips.push(`G√©nero: <b>${gen}</b>`);
  const header = `<h1>Resultado de Sorteo</h1>${chips.length? `<div style="margin:0 0 12px 0;color:#94a3b8">${chips.join(' ¬∑ ')}</div>`:''}`;
  let body = `<div class="grid">`;
  result.groups.forEach((arr,gi)=>{
    const warn = (arr.some((t,idx)=> arr.slice(idx+1).some(u=> u.province && t.province && u.province.toLowerCase()===t.province.toLowerCase()))) ? ' <span class="warn" title="Puede haber provincias repetidas">‚ö†</span>' : '';
    body += `<div class="zone"><h4>Zona ${gi+1}${warn}</h4><ol>`;
    arr.forEach(t=>{
      body += `<li><b>${escapeHtml(t.name)}</b>${t.province?` <span class="muted">‚Äî ${escapeHtml(t.province)}</span>`:''}${t.head?` <span class="pill">Cabeza</span>`:''}</li>`;
    });
    body += `</ol></div>`;
  });
  body += `</div>`;
  win.document.open();
  win.document.write(`<!DOCTYPE html><html><head>${head}</head><body>${header}${body}</body></html>`);
  win.document.close();
}

/* ====================== UI y eventos ====================== */
function setFormat(fmt){
  document.querySelectorAll('input[name="format"]').forEach(r=> r.checked=(r.value===fmt));
  const elZones=document.getElementById('zones');
  if(fmt==='8x3'){ elZones.value=8; elZones.disabled=true }
  else if(fmt==='4x6'){ elZones.value=4; elZones.disabled=true }
  else { elZones.disabled=false }
  updateCapInfo();
}
function summaryCaps(caps){const c3=caps.filter(x=>x===3).length;const c2=caps.filter(x=>x===2).length;const c0=caps.filter(x=>x===0).length;return {c3,c2,c0,txt:`${c3}√ó3, ${c2}√ó2, ${c0}√ó0`}}
function updateCapInfo(){
  const teams=getActiveTeamsLive().length;
  const z=currentZones(); const fmt=getFormat();
  let msg='Activos: '+teams+' ¬∑ Zonas: '+z;
  if(fmt==='4x6'){
    if(teams<=24){const capsPrev=capacitiesFourBySix(teams); const s=summaryCaps(capsPrev); msg+=' ‚Äî Objetivo 6 ¬∑ Dist.: '+capsPrev.join('-')+' ('+s.txt+')'}
    else { msg+=' ‚Äî >24 equipos: distribuci√≥n pareja' }
  } else if(fmt==='8x3'){
    if(teams<=24){const capsPrev=capacitiesEightByThree(teams); const s=summaryCaps(capsPrev); msg+=' ‚Äî Objetivo 3 ¬∑ Dist.: '+capsPrev.join('-')+' ('+s.txt+')'; if(teams<16){msg+=' ‚Äî <span class="warnText"><b>Considere cambiar de sistema</b></span>'}}
    else { msg+=' ‚Äî >24 equipos: distribuci√≥n pareja' }
  } else {
    const per=(teams/z).toFixed(2); msg+=' ‚Äî Promedio: '+per+' por zona';
  }
  document.getElementById('capInfo').innerHTML=msg;
}

document.addEventListener('DOMContentLoaded',function(){
  // Radios de formato
  document.querySelectorAll('input[name="format"]').forEach(r=>{
    r.addEventListener('change',()=> setFormat(r.value));
  });

  // Tabs
  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(b=> b.classList.toggle('active', b===btn));
      document.querySelectorAll('.tabcontent').forEach(c=> c.classList.add('hidden'));
      document.getElementById('tab-'+btn.dataset.tab).classList.remove('hidden');
    });
  });

  // Panel de checks
  document.getElementById('btnBuildList').addEventListener('click', buildListsFromTextarea);
  document.getElementById('toggleShowInactive').addEventListener('change', renderLists);
  document.getElementById('btnMoveToInactive').addEventListener('click', moveSelectedToInactive);
  document.getElementById('btnRestoreSelected').addEventListener('click', restoreSelectedFromInactive);
  document.getElementById('btnSelectAllActive').addEventListener('click', ()=> selectAll('.chkActive'));
  document.getElementById('btnSelectAllInactive').addEventListener('click', ()=> selectAll('.chkInactive'));

  // Equipos CSV
  document.getElementById('csvFile').addEventListener('change',function(e){
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=function(){
      try{
        const parsed=importCSVTeams(reader.result||'');
        const teams=parsed.list;
        if(!teams.length){ toast('CSV vac√≠o o no se detectaron equipos'); return }
        document.getElementById('teamsInput').value = teams.map(t=> t.name+(t.province?'; '+t.province:'')+(t.head?'; *':'')).join('\\n');
        buildListsFromTextarea();
        const prev=teams.slice(0,3).map(t=> t.name+(t.province?' ‚Äî '+t.province:'')+(t.head?' ‚Äî *':'' )).join(' ¬∑ ');
        document.getElementById('csvInfo').innerHTML = 'CSV de equipos: <b>'+teams.length+'</b> filas ¬∑ Delimitador: <b>'+(parsed.delim==='\\t'?'TAB':parsed.delim)+'</b>'+(prev?' ¬∑ Ej: '+prev:'');
        toast('CSV de equipos cargado');
      }catch(err){ console.error(err); alert('No se pudo leer el CSV de equipos.'); }
    };
    reader.readAsText(file,'utf-8');
  });

  // Disciplinas CSV
  document.getElementById('csvDisciplines').addEventListener('change',function(e){
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=function(){
      try{
        const parsed=importCSVDisciplines(reader.result||'');
        disciplines = parsed.list;
        refreshDisciplineSelects();
        const prev=disciplines.slice(0,5).map(d=> d.name).join(' ¬∑ ');
        document.getElementById('discCSVInfo').innerHTML = 'CSV de disciplinas: <b>'+disciplines.length+'</b> filas ¬∑ Delimitador: <b>'+(parsed.delim==='\\t'?'TAB':parsed.delim)+'</b>'+(prev?' ¬∑ Ej: '+prev:'');
        toast('CSV de disciplinas cargado');
      }catch(err){ console.error(err); alert('No se pudo leer el CSV de disciplinas.'); }
    };
    reader.readAsText(file,'utf-8');
  });

  // Categor√≠as CSV
  document.getElementById('csvCategories').addEventListener('change',function(e){
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=function(){
      try{
        const parsed=importCSVCategories(reader.result||'');
        categories = parsed.list;
        refreshCategorySelects();
        const prev=categories.slice(0,5).map(d=> d.name).join(' ¬∑ ');
        document.getElementById('catCSVInfo').innerHTML = 'CSV de categor√≠as: <b>'+categories.length+'</b> filas ¬∑ Delimitador: <b>'+(parsed.delim==='\\t'?'TAB':parsed.delim)+'</b>'+(prev?' ¬∑ Ej: '+prev:'');
        toast('CSV de categor√≠as cargado');
      }catch(err){ console.error(err); alert('No se pudo leer el CSV de categor√≠as.'); }
    };
    reader.readAsText(file,'utf-8');
  });

  // Demos
  document.getElementById('btnDiscDemo').addEventListener('click',()=>{
    disciplines = [
      {name:'F√∫tbol', seed:'futbol-24'},
      {name:'B√°squet', seed:'basquet-24'},
      {name:'V√≥ley', seed:'voley-24'},
      {name:'Handball', seed:'hand-24'},
      {name:'Hockey', seed:'hockey-24'}
    ];
    refreshDisciplineSelects();
    toast('Disciplinas demo cargadas');
  });
  document.getElementById('btnCatDemo').addEventListener('click',()=>{
    categories = [
      {name:'Infantil', code:'INF'},
      {name:'Juvenil', code:'JUV'},
      {name:'Sub-18', code:'S18'},
      {name:'Mayores', code:'MAY'}
    ];
    refreshCategorySelects();
    toast('Categor√≠as demo cargadas');
  });

  // Sincronizar info al tipear (si no se abri√≥ el panel de checks)
  document.getElementById('teamsInput').addEventListener('input', ()=>{
    if(document.getElementById('checkLists').classList.contains('hidden')){
      updateCapInfo();
    }
  });

  // Utilidad
  document.getElementById('btnExample').addEventListener('click',()=>{
    const sample=[[\"River Plate\",\"CABA\",\"*\"],[\"Boca Juniors\",\"CABA\",\"*\"],[\"Newell's\",\"Santa Fe\",\"\"],[\"Rosario Central\",\"Santa Fe\",\"\"],[\"San Lorenzo\",\"CABA\",\"\"],[\"Racing\",\"Buenos Aires\",\"\"],[\"Independiente\",\"Buenos Aires\",\"\"],[\"Estudiantes\",\"Buenos Aires\",\"\"],[\"Talleres\",\"C√≥rdoba\",\"\"],[\"Belgrano\",\"C√≥rdoba\",\"\"],[\"Godoy Cruz\",\"Mendoza\",\"\"],[\"Atl. Tucum√°n\",\"Tucum√°n\",\"\"]];
    document.getElementById('teamsInput').value = sample.map(r=> r.filter(Boolean).join('; ')).join('\\n');
    updateCapInfo();
  });
  document.getElementById('btnClear').addEventListener('click',()=>{
    document.getElementById('teamsInput').value=''; activeTeams=[]; inactiveTeams=[]; document.getElementById('checkLists').classList.add('hidden');
    document.getElementById('resultGroups').innerHTML=''; document.getElementById('status').innerHTML=''; updateCapInfo();
  });

  // Sorteo zonas
  document.getElementById('btnDrawGroups').addEventListener('click',()=>{
    const teams = getActiveTeamsLive();
    if(teams.length===0){ document.getElementById('status').innerHTML='<span class="errorText">No hay equipos activos. Peg√° o import√° una lista.</span>'; return }
    const z=currentZones();
    const seed=getSelectedDisciplineSeed();
    const res=drawGroups(teams,z,seed,document.getElementById('headsAsFirst').checked,getFormat());
    renderGroups(document.getElementById('resultGroups'),res);
    if(!res.error){
      openResultInNewTab(res); // Abrir en pesta√±a nueva
      const iso=new Date().toISOString().replace('T',' ').slice(0,19);
      const item=document.createElement('div'); item.className='item';
      const heads=teams.filter(t=>t.head).length; const provs=[...new Set(teams.map(t=>t.province).filter(Boolean))].length;
      const disc=getSelectedDisciplineName(); const cat=getSelectedCategoryName(); const gen=getSelectedGender();
      const chips=[]; if(disc) chips.push('['+disc+']'); if(cat) chips.push('['+cat+']'); if(gen) chips.push('['+gen+']');
      item.textContent=iso+' ‚Äî '+(chips.join(' ')+' ').trim()+teams.length+' equipos ¬∑ '+z+' zonas ¬∑ cabezas: '+heads+' ¬∑ provincias: '+provs;
      document.getElementById('history').prepend(item);
      if(getFormat()==='8x3' && teams.length<16){ document.getElementById('status').innerHTML+=' ¬∑ <span class="warnText">Considere cambiar de sistema</span>'}
    }
  });

  // Export/Copy/Share/PDF
  document.getElementById('btnExportCSV').addEventListener('click',()=>{
    const boxes=document.querySelectorAll('#resultGroups .zone'); if(!boxes.length){toast('No hay resultado para exportar'); return}
    const teams = getActiveTeamsLive();
    const z=currentZones();
    const seed=getSelectedDisciplineSeed();
    const res=drawGroups(teams,z,seed,document.getElementById('headsAsFirst').checked,getFormat());
    if(res.error){toast('Gener√° el sorteo primero'); return}
    exportGroupsCSV(res.groups);
  });
  document.getElementById('btnCopy').addEventListener('click',()=>{
    const boxes=document.querySelectorAll('#resultGroups .zone'); if(!boxes.length){toast('No hay resultado'); return}
    let txt=''; boxes.forEach((zone,zi)=>{ txt+='Zona '+(zi+1)+'\\n'; zone.querySelectorAll('li').forEach((li,i)=>{ txt+=(i+1)+'. '+li.innerText+'\\n' }); txt+='\\n' });
    copyText(txt);
  });
  document.getElementById('btnShare').addEventListener('click', ()=>{
    if(document.getElementById('checkLists').classList.contains('hidden')){
      activeTeams = parseText(document.getElementById('teamsInput').value);
      inactiveTeams = [];
    }
    setShareLink();
  });
  document.getElementById('btnExportPDF').addEventListener('click', exportPDF);

  // Simple
  document.getElementById('btnUseFromGroups').addEventListener('click',()=>{
    const names = getActiveTeamsLive().map(t=>t.name);
    document.getElementById('simpleInput').value = names.join('\\n');
  });
  document.getElementById('btnClearSimple').addEventListener('click',()=>{document.getElementById('simpleInput').value=''; document.getElementById('resultSimple').innerHTML=''});
  document.getElementById('btnDrawSimple').addEventListener('click',()=>{
    const seed=getSelectedDisciplineSeed();
    const names=document.getElementById('simpleInput').value.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
    if(!names.length){ document.getElementById('statusSimple').innerHTML='<span class="errorText">Peg√° al menos un equipo.</span>'; return }
    const rand=rngFromSeed(seed); const list=shuffle(names,rand);
    const out=list.map((n,i)=> (i+1)+'. '+n).join('\\n');
    document.getElementById('resultSimple').innerHTML = '<pre>'+out.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))+'</pre>';
    document.getElementById('statusSimple').textContent = 'Sorteo realizado.';
  });
  document.getElementById('btnExportSimple').addEventListener('click',()=>{
    const names=document.getElementById('resultSimple').innerText.split('\\n').map(s=>s.replace(/^\\d+\\.\\s*/,'').trim()).filter(Boolean);
    if(!names.length){ toast('Gener√° el sorteo primero'); return }
    exportSimpleCSV(names);
  });
  document.getElementById('btnCopySimple').addEventListener('click',()=>{
    const txt=document.getElementById('resultSimple').innerText; if(!txt){ toast('No hay resultado'); return } copyText(txt);
  });

  // Bracket
  function nextPow2(x){let p=1;while(p<x) p<<=1;return p}
  function buildBracket(names,seed){const rand=rngFromSeed(seed);const list=shuffle(names,rand);const target=nextPow2(list.length);while(list.length<target) list.push('BYE');const matches=[];for(let i=0;i<list.length;i+=2){matches.push([list[i],list[i+1]])}return matches}
  function renderBracket(target,matches){target.innerHTML='';const grid=document.createElement('div');grid.className='grid';matches.forEach((m,i)=>{const card=document.createElement('div');card.className='zone';card.innerHTML='<h4>Partido '+(i+1)+'</h4><ol><li><b>'+m[0]+'</b></li><li><b>'+m[1]+'</b></li></ol>';grid.appendChild(card)});target.appendChild(grid)}
  document.getElementById('btnUseFromGroups2').addEventListener('click',()=>{
    document.getElementById('bracketInput').value = getActiveTeamsLive().map(t=>t.name).join('\\n');
  });
  document.getElementById('btnClearBracket').addEventListener('click',()=>{document.getElementById('bracketInput').value=''; document.getElementById('resultBracket').innerHTML=''});
  document.getElementById('btnDrawBracket').addEventListener('click',()=>{
    const seed=getSelectedDisciplineSeed();
    const names=document.getElementById('bracketInput').value.split(/\\r?\\n/).map(s=>s.trim()).filter(Boolean);
    if(names.length<2){ document.getElementById('statusBracket').innerHTML='<span class="errorText">Peg√° al menos dos equipos.</span>'; return }
    const matches=buildBracket(names, seed);
    renderBracket(document.getElementById('resultBracket'), matches);
    document.getElementById('statusBracket').textContent = 'Llaves generadas (ronda 1).';
  });
  document.getElementById('btnExportBracket').addEventListener('click',()=>{
    const boxes=document.querySelectorAll('#resultBracket .zone'); if(!boxes.length){ toast('Gener√° las llaves primero'); return }
    const matches=[]; boxes.forEach(b=>{ const lis=b.querySelectorAll('li'); matches.push([lis[0].innerText, lis[1].innerText]); });
    exportBracketCSV(matches);
  });

  tryLoadFromHash();
  setFormat(document.querySelector('input[name="format"]:checked')?.value || '8x3');
  updateCapInfo();
  refreshDisciplineSelects();
  refreshCategorySelects();
});
</script>
</body>
</html>
