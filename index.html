<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sorteador Deportivo</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:#0f172a;color:#e5e7eb;margin:0;padding:20px}
.container{max-width:900px;margin:auto;background:#111827;padding:20px;border-radius:12px}
textarea{width:100%;min-height:220px;border-radius:8px;background:#0b1220;color:#e5e7eb;border:1px solid #223046;padding:10px;font-size:14px}
.btn{background:#1f2937;color:#e5e7eb;border:1px solid #374151;border-radius:8px;padding:8px 14px;cursor:pointer;margin-top:8px}
.btn:hover{background:#374151}
ul{list-style:none;padding-left:0}
li{margin:4px 0;display:flex;align-items:center;gap:8px}
input[type=checkbox]{transform:scale(1.2)}
</style>
</head>
<body>
<div class="container">
  <h1>üé≤ Sorteador Deportivo v1.1</h1>
  <label>Equipos (uno por l√≠nea o importar CSV)</label>
  <textarea id="teamsInput" placeholder="Ejemplo: River Plate; CABA; *\nBoca Juniors; CABA"></textarea>
  <div>
    <label for="csvFile" class="btn">üìÑ Importar CSV</label>
    <input id="csvFile" type="file" accept=".csv" style="display:none">
    <button class="btn" id="btnRender">Mostrar lista con checks</button>
    <button class="btn" id="btnRemove">‚ùå Eliminar seleccionados</button>
  </div>
  <ul id="teamsList"></ul>
</div>
<script>
function parseLine(line){const raw=line.replace(/\t/g,',').trim();if(!raw)return null;let parts=raw.split(';');if(parts.length===1)parts=raw.split(',');parts=parts.map(s=>s.trim()).filter(Boolean);const name=parts[0]||'';const province=(parts[1]||'').replace(/\*+$/,'').trim();let head=false;if(parts.length>=3){head=/\*|si|s√≠|head/i.test(parts[2])}if(/\*$/.test(name)){head=true}return{name:name.replace(/\*+$/,'').trim(),province,head}}
function parseTeams(txt){return txt.split(/\r?\n/).map(parseLine).filter(t=>t&&t.name)}
function renderList(){const ul=document.getElementById('teamsList');ul.innerHTML='';teams=parseTeams(document.getElementById('teamsInput').value);teams.forEach((t,i)=>{const li=document.createElement('li');const chk=document.createElement('input');chk.type='checkbox';chk.dataset.index=i;const lbl=document.createElement('label');lbl.textContent=t.name+(t.province?' ‚Äî '+t.province:'')+(t.head?' ‚òÖ':'');li.appendChild(chk);li.appendChild(lbl);ul.appendChild(li)});} 
document.getElementById('btnRender').addEventListener('click',renderList);
document.getElementById('btnRemove').addEventListener('click',()=>{const checks=[...document.querySelectorAll('#teamsList input[type=checkbox]:checked')];if(!checks.length){alert('No hay equipos seleccionados');return}let lines=parseTeams(document.getElementById('teamsInput').value);const idxs=checks.map(c=>parseInt(c.dataset.index));lines=lines.filter((_,i)=>!idxs.includes(i));document.getElementById('teamsInput').value=lines.map(t=>t.name+(t.province?'; '+t.province:'')+(t.head?'; *':'')).join('\n');renderList();});
// CSV import b√°sico
document.getElementById('csvFile').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{document.getElementById('teamsInput').value=r.result;renderList()};r.readAsText(f,'utf-8')});
</script>
  
  <!-- ==================== INTEGRACI√ìN AVANZADA ==================== -->
  <div class="container" id="advanced-ui" style="margin-top:16px">
    <div class="panel">
      <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between">
        <h2 style="margin:0;font-size:18px">‚öôÔ∏è Opciones de sorteo</h2>
        <div class="tiny">Usa la lista de arriba. Pod√©s descartar/restaurar equipos con los checks.</div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="card">
          <h3>Par√°metros</h3>
          <div class="controls">
            <label class="pill"><input type="radio" name="adv-format" value="8x3" checked> 8 zonas de 3</label>
            <label class="pill"><input type="radio" name="adv-format" value="4x6"> 4 zonas de 6</label>
            <label class="pill"><input type="radio" name="adv-format" value="custom"> Personalizado</label>
          </div>
          <div class="controls" style="margin-top:8px">
            <div style="min-width:160px;flex:1">
              <label>N¬∫ de zonas</label>
              <input type="number" id="adv-zones" min="1" value="8">
            </div>
            <div style="min-width:200px;flex:1">
              <label>Disciplina (opcional)</label>
              <input type="text" id="adv-seed" placeholder="p.ej. evita-2025">
            </div>
          </div>
          <label><input type="checkbox" id="adv-avoid" checked> Evitar misma provincia en la zona</label>
          <label><input type="checkbox" id="adv-heads" checked> Cabezas de serie primero</label>
          <div id="adv-cap" class="tiny" style="margin-top:6px"></div>
          <div class="controls" style="margin-top:10px">
            <button class="btn primary" id="adv-draw">üéØ SORTEAR ZONAS</button>
            <button class="btn" id="adv-export">‚¨áÔ∏è Exportar CSV</button>
            <button class="btn" id="adv-copy">üìã Copiar</button>
            <button class="btn" id="adv-share">üîó Compartir</button>
            <button class="btn" id="adv-pdf">üñ®Ô∏è Exportar PDF</button>
          </div>
          <div id="adv-status" class="tiny" style="margin-top:6px"></div>
        </div>
        <div class="card">
          <h3>Eliminaci√≥n directa (beta)</h3>
          <div class="tiny">Toma los equipos de la lista actual. Si no es potencia de 2, se completa con BYE.</div>
          <div class="controls" style="margin-top:8px">
            <input type="text" id="adv-seed-bracket" placeholder="Disciplina (opcional)" style="flex:1;min-width:220px">
            <button class="btn" id="adv-bracket">ü•ä Generar llaves</button>
            <button class="btn" id="adv-bracket-csv">‚¨áÔ∏è Exportar CSV</button>
          </div>
          <div id="adv-status-bracket" class="tiny" style="margin-top:6px"></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Resultado ‚Äî Zonas</h3>
      <div id="adv-result" class="grid"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Resultado ‚Äî Llaves</h3>
      <div id="adv-bracket-out" class="grid"></div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';
    // Utilidades sin expresiones regulares problem√°ticas
    function rngFromSeed(seed){
      if(!seed||seed.trim()==='') return Math.random;
      var h=1779033703 ^ seed.length;
      for(var i=0;i<seed.length;i++){ h = Math.imul(h ^ seed.charCodeAt(i), 3432918353); h = (h<<13) | (h>>>19); }
      var a=(h>>>0);
      return function(){ a = (a + 1831565813)>>>0; var t=a; t=Math.imul(t ^ (t>>>15), t|1); t ^= t + Math.imul(t ^ (t>>>7), t | 61); return ((t ^ (t>>>14))>>>0) / 4294967296; };
    }
    function shuffle(arr,rand){ var a=arr.slice(); for(var i=a.length-1;i>0;i--){ var j=Math.floor(rand()*(i+1)); var tmp=a[i]; a[i]=a[j]; a[j]=tmp; } return a; }

    function capacities(n,z){ var base=Math.floor(n/z), r=n%z, out=[]; for(var i=0;i<z;i++){ out.push(base + (i<r?1:0)); } return out; }
    function capacitiesFourBySix(n){ var caps=[6,6,6,6]; var total=24; if(n>=total) return caps; var d=total-n; var order=[3,1,2,0]; var k=0; while(d>0){ var idx=order[k%order.length]; if(caps[idx]>0){ caps[idx]--; d--; } k++; } return caps; }
    function capacitiesEightByThree(n){ var caps=[3,3,3,3,3,3,3,3]; var total=24; if(n>=total) return caps; var d=total-n; var zeros=Math.floor(d/3); var twos=d%3; var order=[7,6,5,4,3,2,1,0]; var i; for(i=0;i<zeros;i++){ caps[order[i]]=0; } var p=zeros; for(i=0;i<twos && p<order.length;i++,p++){ if(caps[order[p]]===3) caps[order[p]]=2; } return caps; }

    function getTeams(){
      // usa el parseador ya presente en el archivo
      if(typeof parseTeams==='function') return parseTeams(document.getElementById('teamsInput').value);
      // fallback m√≠nimo si no existiera
      var lines=document.getElementById('teamsInput').value.split('
');
      var out=[]; for(var i=0;i<lines.length;i++){ var s=lines[i].trim(); if(!s) continue; var p=s.split(';'); var name=(p[0]||'').trim(); var province=(p[1]||'').trim(); var head=(p.length>2 && (p[2]||'').toLowerCase().indexOf('si')>-1); out.push({name:name,province:province,head:head}); }
      return out;
    }

    function canPlace(team,group,avoid){ if(!avoid) return true; if(!team.province) return true; for(var i=0;i<group.length;i++){ var t=group[i]; if(t.province && t.province.toLowerCase()===team.province.toLowerCase()) return false; } return true; }

    function draw(teams,z,avoid,seed,headsFirst,fmt){
      var rand=rngFromSeed(seed), n=teams.length; if(z<1) return {error:'El n¬∫ de zonas debe ser 1 o m√°s'}; if(n<z) return {error:'Hay menos equipos que zonas'};
      var caps=(fmt==='4x6' && z===4 && n<=24)?capacitiesFourBySix(n):(fmt==='8x3' && z===8 && n<=24?capacitiesEightByThree(n):capacities(n,z));
      var groups=[]; for(var i=0;i<z;i++) groups.push([]);
      var heads=teams.filter(function(t){return t.head}); heads=shuffle(heads,rand);
      var others=teams.filter(function(t){return !t.head}); others=shuffle(others,rand);
      if(headsFirst){ for(i=0;i<groups.length && i<heads.length;i++){ groups[i].push(heads[i]); } }
      var remaining=caps.slice(); for(i=0;i<groups.length;i++){ remaining[i]=Math.max(0, remaining[i]-groups[i].length); }
      var pool=headsFirst?others:shuffle(teams,rand);
      var attempts=400, best=null, bestScore=1e9;
      while(attempts--){
        var g=groups.map(function(a){return a.slice()}); var cap=remaining.slice(); var ok=true;
        var order=shuffle(pool,rand);
        for(var k=0;k<order.length;k++){
          var team=order[k];
          var candidates=[]; for(i=0;i<g.length;i++){ if(cap[i]>0) candidates.push({i:i, s:g[i].length}); }
          candidates.sort(function(a,b){ return a.s-b.s || a.i-b.i });
          var placed=false;
          for(i=0;i<candidates.length;i++){ var idx=candidates[i].i; if(canPlace(team,g[idx],avoid)){ g[idx].push(team); cap[idx]--; placed=true; break; } }
          if(!placed && candidates.length){ var pick=candidates[Math.floor(rand()*candidates.length)].i; g[pick].push(team); cap[pick]--; placed=true; }
          if(!placed){ ok=false; break; }
        }
        if(ok){ return {groups:g, caps:caps, relaxed:false}; }
        // score por repeticiones de provincia
        var score=0; for(i=0;i<g.length;i++){ var seen={}; for(k=0;k<g[i].length;k++){ var pr=g[i][k].province?g[i][k].province.toLowerCase():''; if(!pr) continue; seen[pr]=(seen[pr]||0)+1; }
          for(var key in seen){ if(seen[key]>1) score += (seen[key]-1); } }
        if(score<bestScore){ bestScore=score; best={groups:g, caps:caps, relaxed:true}; }
      }
      return best || {error:'No se pudo asignar. Prob√° sin restricciones.'};
    }

    function renderGroups(target,res){
      var el=document.getElementById(target); var wrap=document.createElement('div'); wrap.className='grid';
      if(res.error){ el.innerHTML='<div class="errorText">'+res.error+'</div>'; return; }
      for(var i=0;i<res.groups.length;i++){
        var arr=res.groups[i]; var card=document.createElement('div'); card.className='zone';
        var h=document.createElement('h4'); h.innerHTML='Zona '+(i+1)+' <span class="muted">(' + arr.length + '/' + res.caps[i] + ')</span>';
        card.appendChild(h);
        var ol=document.createElement('ol');
        for(var j=0;j<arr.length;j++){ var li=document.createElement('li'); var t=arr[j]; var extra=t.province? ' ‚Äî ' + t.province : ''; var head=t.head? ' <span class="pill">Cabeza</span>' : ''; li.innerHTML='<b>'+t.name+'</b>'+extra+head; ol.appendChild(li); }
        card.appendChild(ol); wrap.appendChild(card);
      }
      var host=document.getElementById(target); host.innerHTML=''; host.appendChild(wrap);
    }

    function textGroups(res){
      var out=[]; for(var i=0;i<res.groups.length;i++){ out.push('Zona '+(i+1)); var g=res.groups[i]; for(var j=0;j<g.length;j++){ out.push((j+1)+'. '+g[j].name + (g[j].province? ' ‚Äî '+g[j].province : '')); } out.push(''); }
      return out.join('
');
    }
    function csvGroups(res){
      var lines=['Zona,Posicion,Equipo,Provincia,Cuadro'];
      for(var i=0;i<res.groups.length;i++){ var g=res.groups[i]; for(var j=0;j<g.length;j++){ var t=g[j]; lines.push((i+1)+','+(j+1)+',"'+t.name.replace(/"/g,'"')+'",'+(t.province?'"'+t.province.replace(/"/g,'"')+'"':'')+','+(t.head?'Cabeza':'')); } }
      return lines.join('
');
    }
    function downloadText(text,filename){ var blob=new Blob([text],{type:'text/plain;charset=utf-8'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }

    function updateCapInfo(){
      var t=getTeams(); var z=parseInt(document.getElementById('adv-zones').value,10)||1; var fmt=document.querySelector('input[name="adv-format"]:checked').value; var msg='Equipos: '+t.length+' ¬∑ Zonas: '+z;
      var caps=null; if(fmt==='4x6' && z===4 && t.length<=24){ caps=capacitiesFourBySix(t.length); msg += ' ‚Äî objetivo 6 por zona'; }
      else if(fmt==='8x3' && z===8 && t.length<=24){ caps=capacitiesEightByThree(t.length); msg += ' ‚Äî objetivo 3 por zona'; }
      else { caps=capacities(t.length,z); }
      document.getElementById('adv-cap').innerHTML = msg + ' ‚Äî dist: ' + caps.join('-');
    }

    // Eventos
    document.querySelectorAll('input[name="adv-format"]').forEach(function(r){ r.addEventListener('change',function(){ var v=r.value; var ez=document.getElementById('adv-zones'); if(v==='8x3'){ ez.value=8; ez.disabled=true; } else if(v==='4x6'){ ez.value=4; ez.disabled=true; } else { ez.disabled=false; } updateCapInfo(); }); });
    document.getElementById('adv-zones').addEventListener('input',updateCapInfo);
    document.getElementById('teamsInput').addEventListener('input',updateCapInfo);

    document.getElementById('adv-draw').addEventListener('click',function(){
      var res=draw(getTeams(), parseInt(document.getElementById('adv-zones').value,10)||1, document.getElementById('adv-avoid').checked, document.getElementById('adv-seed').value.trim(), document.getElementById('adv-heads').checked, document.querySelector('input[name="adv-format"]:checked').value);
      if(res.error){ document.getElementById('adv-status').innerHTML='<span class="errorText">'+res.error+'</span>'; return; }
      renderGroups('adv-result',res);
      document.getElementById('adv-status').textContent='Sorteo realizado'+(res.relaxed?' (con relajaci√≥n)':'');
    });

    document.getElementById('adv-copy').addEventListener('click',function(){ var box=document.getElementById('adv-result'); if(!box.innerText.trim()){ alert('No hay resultado'); return; } var txt=''; box.querySelectorAll('.zone').forEach(function(z,i){ txt += 'Zona '+(i+1)+'
'; z.querySelectorAll('li').forEach(function(li,j){ txt += (j+1)+'. '+li.innerText+'
'; }); txt += '
'; }); navigator.clipboard.writeText(txt).then(function(){ alert('Copiado'); }); });

    document.getElementById('adv-export').addEventListener('click',function(){ var box=document.getElementById('adv-result'); if(!box.innerText.trim()){ alert('No hay resultado'); return; } var res=draw(getTeams(), parseInt(document.getElementById('adv-zones').value,10)||1, document.getElementById('adv-avoid').checked, document.getElementById('adv-seed').value.trim(), document.getElementById('adv-heads').checked, document.querySelector('input[name="adv-format"]:checked').value); if(res.error){ alert('Gener√° el sorteo primero'); return; } downloadText(csvGroups(res),'sorteo_zonas.csv'); });

    document.getElementById('adv-share').addEventListener('click',function(){ var st={ teams:getTeams(), z:parseInt(document.getElementById('adv-zones').value,10)||1, avoid:document.getElementById('adv-avoid').checked, heads:document.getElementById('adv-heads').checked, seed:document.getElementById('adv-seed').value.trim(), fmt:document.querySelector('input[name="adv-format"]:checked').value }; var url=location.origin+location.pathname+'#'+btoa(unescape(encodeURIComponent(JSON.stringify(st)))); navigator.clipboard.writeText(url).then(function(){ alert('Link copiado'); }); });

    function loadScript(url){ return new Promise(function(res,rej){ var s=document.createElement('script'); s.src=url; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }
    async function exportPDF(){
      var box=document.getElementById('adv-result'); if(!box.innerText.trim()){ alert('No hay resultado'); return; }
      await loadScript('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');
      await loadScript('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js');
      var el=document.createElement('div'); el.style.background='#ffffff'; el.style.color='#0f172a'; el.style.padding='12px';
      var title=document.createElement('div'); title.style.fontWeight='700'; title.style.marginBottom='8px'; title.textContent='Sorteo ‚Äî '+new Date().toLocaleString(); el.appendChild(title);
      el.appendChild(box.cloneNode(true)); document.body.appendChild(el);
      var canvas=await html2canvas(el,{backgroundColor:'#ffffff',scale:2}); var img=canvas.toDataURL('image/png'); document.body.removeChild(el);
      var pdf=new window.jspdf.jsPDF({orientation:'portrait',unit:'pt',format:'a4'}); var pw=pdf.internal.pageSize.getWidth(); var ph=pdf.internal.pageSize.getHeight(); pdf.addImage(img,'PNG',0,0,pw,Math.min(ph,pw*canvas.height/canvas.width)); pdf.save('sorteo.pdf');
    }
    document.getElementById('adv-pdf').addEventListener('click',function(){ exportPDF().catch(function(){ alert('No se pudo exportar el PDF'); }); });

    // Bracket
    function nextPow2(x){ var p=1; while(p<x) p=p*2; return p; }
    function buildBracket(names,seed){ var rand=rngFromSeed(seed); var list=shuffle(names,rand); var target=nextPow2(list.length); while(list.length<target) list.push('BYE'); var out=[]; for(var i=0;i<list.length;i+=2){ out.push([list[i],list[i+1]]); } return out; }
    function renderBracket(matches){ var host=document.getElementById('adv-bracket-out'); host.innerHTML=''; var grid=document.createElement('div'); grid.className='grid'; for(var i=0;i<matches.length;i++){ var m=matches[i]; var card=document.createElement('div'); card.className='zone'; var h=document.createElement('h4'); h.textContent='Partido '+(i+1); card.appendChild(h); var ol=document.createElement('ol'); var li1=document.createElement('li'); li1.innerHTML='<b>'+m[0]+'</b>'; var li2=document.createElement('li'); li2.innerHTML='<b>'+m[1]+'</b>'; ol.appendChild(li1); ol.appendChild(li2); card.appendChild(ol); grid.appendChild(card); } host.appendChild(grid); }

    document.getElementById('adv-bracket').addEventListener('click',function(){ var teams=getTeams().map(function(t){return t.name}); if(teams.length<2){ document.getElementById('adv-status-bracket').innerHTML='<span class="errorText">Peg√° al menos dos equipos.</span>'; return; } var matches=buildBracket(teams, document.getElementById('adv-seed-bracket').value.trim()); renderBracket(matches); document.getElementById('adv-status-bracket').textContent='Llaves generadas'; });
    document.getElementById('adv-bracket-csv').addEventListener('click',function(){ var boxes=document.querySelectorAll('#adv-bracket-out .zone'); if(!boxes.length){ alert('Gener√° las llaves primero'); return; } var lines=['Llave,Partido,Equipo A,Equipo B']; boxes.forEach(function(b,i){ var lis=b.querySelectorAll('li'); lines.push('Ronda 1,'+(i+1)+',"'+lis[0].innerText+'","'+lis[1].innerText+'"'); }); downloadText(lines.join('
'),'llaves.csv'); });

    // Inicial
    updateCapInfo();
  })();
  </script>

</body>
</html>
