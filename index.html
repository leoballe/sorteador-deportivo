<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sorteador Deportivo Pro</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- Utilidades PDF en la pesta√±a de resultado -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>

  <style>
    :root{--bg:#0f172a;--panel:#111827;--card:#1f2937;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent2:#38bdf8;--danger:#ef4444;--warn:#f59e0b}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    a{color:var(--accent2)}
    .container{max-width:1100px;margin:0 auto;padding:24px}

    /* Header app */
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:clamp(22px,3vw,30px);margin:0}
    .badge{font-size:12px;background:#0b2;opacity:.9;padding:4px 8px;border-radius:999px}
    .userBox{display:flex;align-items:center;gap:8px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border:1px solid #2b3b55;border-radius:999px;background:#0b1220}
    .btn{background:#0b1220;color:var(--text);border:1px solid #223046;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn:hover{border-color:#3b82f6}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#16a34a);border:0;color:#052e16}
    .btn.ghost{background:transparent;border-color:#2b3b55}
    .btn.warn{background:linear-gradient(135deg,var(--warn),#d97706);border:0;color:#3b1d00}
    .tiny{font-size:12px;color:var(--muted)}
    .hidden{display:none}

    /* Paneles y tarjetas */
    .panel{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #243042;border-radius:14px;padding:14px}
    .card h3{margin:0 0 8px 0;font-size:16px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=number],input[type=email],input[type=password],textarea,select{
      width:100%;background:#0b1220;color:var(--text);border:1px solid #223046;border-radius:10px;padding:10px;font-size:14px
    }
    textarea{min-height:200px;resize:vertical}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}

    /* Tabs */
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:10px;border:1px solid #223046;background:#0b1220;cursor:pointer;color:#e5e7eb}
    .tab.active{background:#0a3622;border-color:#1b5e3b;color:#22c55e}

    /* Resultado */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
    .zone{background:#0b1220;border:1px solid #223046;border-radius:14px;padding:10px}
    .zone h4{margin:4px 0 8px 0}
    .zone ol{margin:0;padding-left:18px}
    .muted{color:var(--muted)}
    .warnText{color:var(--warn)}
    .errorText{color:var(--danger)}

    /* Listas con checks */
    .history{display:grid;gap:8px}
    .history .item{background:#0b1220;border:1px dashed #2b3b55;padding:8px;border-radius:10px;font-size:13px}
    .listWrap{display:grid;grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:900px){.listWrap{grid-template-columns:1fr}}
    .listBox{background:#0b1220;border:1px dashed #2b3b55;border-radius:12px;padding:10px;min-height:120px}
    .listBox h4{margin:2px 0 8px 0;font-size:14px}
    .itemRow{display:flex;align-items:center;gap:8px;padding:4px 6px;border-bottom:1px dashed #1f2a3b}
    .itemRow:last-child{border-bottom:none}
    .tag{font-size:11px;color:#cbd5e1;border:1px solid #334155;border-radius:999px;padding:1px 6px}
  </style>
</head>
<body>

  <!-- ============ Secci√≥n de Autenticaci√≥n ============ -->
  <section id="authSection" class="authWrap" style="max-width:460px;margin:48px auto">
    <div class="authBrand" style="display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:14px">
      <h1 style="margin:0">üé≤ Sorteador Deportivo Pro</h1>
    </div>
    <div class="card" style="background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:16px">
      <div class="authTabs" style="display:flex;border-bottom:1px solid #223046;margin-bottom:14px">
        <button class="authTab active" data-tab="login" style="flex:1;padding:10px;text-align:center;background:none;border:none;color:var(--text);cursor:pointer;border-bottom:2px solid #22c55e">Iniciar Sesi√≥n</button>
        <button class="authTab" data-tab="register" style="flex:1;padding:10px;text-align:center;background:none;border:none;color:var(--text);cursor:pointer;border-bottom:2px solid transparent">Registrarse</button>
      </div>

      <!-- Login -->
      <form class="authForm" id="loginForm">
        <div class="formGroup" style="margin-bottom:12px">
          <label for="loginEmail">Email</label>
          <input type="email" id="loginEmail" required placeholder="tu@email.com">
        </div>
        <div class="formGroup" style="margin-bottom:12px">
          <label for="loginPassword">Contrase√±a</label>
          <input type="password" id="loginPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button type="submit" class="btn primary" style="width:100%">Iniciar Sesi√≥n</button>
      </form>

      <!-- Registro -->
      <form class="authForm hidden" id="registerForm">
        <div class="formGroup" style="margin-bottom:12px">
          <label for="registerName">Nombre</label>
          <input type="text" id="registerName" required placeholder="Tu nombre">
        </div>
        <div class="formGroup" style="margin-bottom:12px">
          <label for="registerEmail">Email</label>
          <input type="email" id="registerEmail" required placeholder="tu@email.com">
        </div>
        <div class="formGroup" style="margin-bottom:12px">
          <label for="registerPassword">Contrase√±a</label>
          <input type="password" id="registerPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
        </div>
        <div class="formGroup" style="margin-bottom:12px">
          <label for="registerConfirmPassword">Confirmar Contrase√±a</label>
          <input type="password" id="registerConfirmPassword" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        </div>
        <button type="submit" class="btn primary" style="width:100%">Crear Cuenta</button>
      </form>
    </div>
    <div class="tiny" style="margin-top:10px;text-align:center">Todo ocurre del lado del cliente.</div>
  </section>

  <!-- ============ Aplicaci√≥n (se muestra tras login) ============ -->
  <section id="appSection" class="hidden">
    <div class="container">
      <header>
        <div>
          <h1>üé≤ Sorteador Deportivo</h1>
          <div class="tiny">Funciona 100% en tu navegador (sin backend).</div>
        </div>
        <div class="userBox">
          <span class="pill" id="userInfo" title="Usuario"></span>
          <button id="logoutBtn" class="btn ghost">Cerrar sesi√≥n</button>
          <span class="badge">v2.5 Pro (Auth + Cloud)</span>
        </div>
      </header>

      <div class="panel">
        <div class="tabs">
          <button class="tab active" data-tab="grupos" type="button">Zonas / Grupos</button>
          <button class="tab" data-tab="simple" type="button">Sorteo simple</button>
          <button class="tab" data-tab="bracket" type="button">Eliminaci√≥n directa (beta)</button>
        </div>

        <div id="tab-grupos" class="tabcontent">
          <div class="row">
            <div class="card">
              <h3>Equipos</h3>
              <label>Peg√° la lista (una l√≠nea por equipo). Opcional: <span class="pill">; Provincia</span> y <span class="pill">; *</span> para cabeza.</label>
              <textarea id="teamsInput" placeholder="Ejemplos:
River Plate; CABA; *
Boca Juniors; CABA
Newell's; Santa Fe
..."></textarea>
              <div class="controls" style="margin-top:8px">
                <label for="csvFile" class="btn ghost">üìÑ Importar CSV de equipos</label>
                <input id="csvFile" type="file" accept=".csv,text/csv" class="hidden" />
                <button class="btn ghost" id="btnExample" type="button">Cargar ejemplo</button>
                <button class="btn ghost" id="btnClear" type="button">Limpiar</button>
                <button class="btn" id="btnBuildList" type="button">üóÇÔ∏è Mostrar lista con checks</button>
              </div>
              <div class="tiny">CSV de equipos: <b>Equipo, Provincia, Cabeza</b> ("s√≠" para cabeza). Acepta <b>,</b>, <b>;</b> o <b>TAB</b>, con o sin cabecera.</div>
              <div id="csvInfo" class="tiny" style="margin-top:6px"></div>

              <div id="checkLists" class="listWrap hidden" style="margin-top:10px">
                <div class="listBox">
                  <h4>Activos (participan) <span class="tag" id="countActive">0</span></h4>
                  <div class="controls" style="margin-bottom:6px">
                    <button class="btn tiny" id="btnSelectAllActive" type="button">Seleccionar todo</button>
                    <button class="btn warn tiny" id="btnMoveToInactive" type="button">Descartar seleccionados ‚ûú</button>
                  </div>
                  <div id="activeList"></div>
                </div>
                <div class="listBox">
                  <h4>Descartados <span class="tag" id="countInactive">0</span></h4>
                  <div class="controls" style="margin-bottom:6px">
                    <label class="pill"><input type="checkbox" id="toggleShowInactive"> Mostrar descartados</label>
                    <button class="btn tiny" id="btnSelectAllInactive" type="button">Seleccionar todo</button>
                    <button class="btn primary tiny" id="btnRestoreSelected" type="button">‚¨Ö Restaurar seleccionados</button>
                  </div>
                  <div id="inactiveList" class="hidden"></div>
                </div>
              </div>
            </div>

            <div class="card">
              <h3>Par√°metros</h3>
              <div class="controls" id="formatRow">
                <label class="pill"><input type="radio" name="format" value="8x3" checked> 8 zonas de 3</label>
                <label class="pill"><input type="radio" name="format" value="4x6"> 4 zonas de 6</label>
                <label class="pill"><input type="radio" name="format" value="custom"> Personalizado</label>
              </div>
              <div class="controls">
                <div style="min-width:160px;flex:1">
                  <label>N¬∫ de zonas / grupos</label>
                  <input type="number" id="zones" min="1" value="8" />
                </div>
                <div style="min-width:220px;flex:1">
                  <label>Disciplina</label>
                  <select id="disciplineSelect">
                    <option value="">‚Äî Seleccionar disciplina ‚Äî</option>
                  </select>
                </div>
              </div>
              <div class="controls">
                <div style="min-width:220px;flex:1">
                  <label>Categor√≠a</label>
                  <select id="categorySelect">
                    <option value="">‚Äî Seleccionar categor√≠a ‚Äî</option>
                  </select>
                </div>
                <div style="min-width:220px;flex:1">
                  <label>G√©nero</label>
                  <select id="genderSelect">
                    <option value="">‚Äî Seleccionar g√©nero ‚Äî</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Femenino">Femenino</option>
                    <option value="Mixto">Mixto</option>
                    <option value="No Aplica">No Aplica</option>
                  </select>
                </div>
              </div>
              <div class="controls">
                <label for="csvDisciplines" class="btn ghost">üìÑ Importar CSV de disciplinas</label>
                <input id="csvDisciplines" type="file" accept=".csv,text/csv" class="hidden" />
                <button class="btn ghost" id="btnDiscDemo" type="button">Cargar disciplinas demo</button>
                <label for="csvCategories" class="btn ghost">üìÑ Importar CSV de categor√≠as</label>
                <input id="csvCategories" type="file" accept=".csv,text/csv" class="hidden" />
                <button class="btn ghost" id="btnCatDemo" type="button">Cargar categor√≠as demo</button>
              </div>
              <div id="discCSVInfo" class="tiny" style="margin-top:4px"></div>
              <div id="catCSVInfo" class="tiny" style="margin-top:4px"></div>

              <label><input type="checkbox" id="headsAsFirst" checked> Cabezas de serie primero</label>
              <div id="capInfo" class="tiny" style="margin-top:6px"></div>

              <div class="controls" style="margin-top:10px">
                <button class="btn primary" id="btnDrawGroups" type="button">üéØ SORTEAR ZONAS</button>
                <button class="btn" id="btnExportCSV" type="button">‚¨áÔ∏è Exportar CSV</button>
                <button class="btn" id="btnCopy" type="button">üìã Copiar</button>
                <button class="btn" id="btnShare" type="button">üîó Compartir</button>
              </div>
              <div id="status" class="tiny" style="margin-top:8px"></div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Resultado</h3>
            <div id="resultGroups" class="grid"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Historial (local)</h3>
            <div class="history" id="history"></div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Mis sorteos (en la nube)</h3>
            <div class="history" id="cloudHistory"></div>
          </div>
        </div>

        <div id="tab-simple" class="tabcontent hidden">
          <div class="row">
            <div class="card">
              <h3>Equipos</h3>
              <label>Usa la lista del tab Grupos (o peg√° otra):</label>
              <textarea id="simpleInput" placeholder="Uno por l√≠nea..."></textarea>
              <div class="controls" style="margin-top:8px">
                <button class="btn ghost" id="btnUseFromGroups" type="button">Usar lista del tab Grupos</button>
                <button class="btn ghost" id="btnClearSimple" type="button">Limpiar</button>
              </div>
            </div>
            <div class="card">
              <h3>Par√°metros</h3>
              <div class="controls">
                <div style="min-width:220px;flex:1">
                  <label>Disciplina</label>
                  <select id="disciplineSelectSimple">
                    <option value="">‚Äî Seleccionar disciplina ‚Äî</option>
                  </select>
                </div>
              </div>
              <div class="controls" style="margin-top:10px">
                <button class="btn primary" id="btnDrawSimple" type="button">üé≤ SORTEAR ORDEN</button>
                <button class="btn" id="btnExportSimple" type="button">‚¨áÔ∏è Exportar CSV</button>
                <button class="btn" id="btnCopySimple" type="button">üìã Copiar</button>
              </div>
              <div id="statusSimple" class="tiny" style="margin-top:8px"></div>
            </div>
          </div>
          <div class="card" style="margin-top:12px">
            <h3>Resultado</h3>
            <div id="resultSimple"></div>
          </div>
        </div>

        <div id="tab-bracket" class="tabcontent hidden">
          <div class="row">
            <div class="card">
              <h3>Equipos</h3>
              <label>Usa la lista del tab Grupos (o peg√° otra):</label>
              <textarea id="bracketInput" placeholder="Uno por l√≠nea..."></textarea>
              <div class="controls" style="margin-top:8px">
                <button class="btn ghost" id="btnUseFromGroups2" type="button">Usar lista del tab Grupos</button>
                <button class="btn ghost" id="btnClearBracket" type="button">Limpiar</button>
              </div>
            </div>
            <div class="card">
              <h3>Par√°metros</h3>
              <div class="controls">
                <div style="min-width:220px;flex:1">
                  <label>Disciplina</label>
                  <select id="disciplineSelectBracket">
                    <option value="">‚Äî Seleccionar disciplina ‚Äî</option>
                  </select>
                </div>
              </div>
              <div class="controls" style="margin-top:10px">
                <button class="btn primary" id="btnDrawBracket" type="button">ü•ä Generar llaves</button>
                <button class="btn" id="btnExportBracket" type="button">‚¨áÔ∏è Exportar CSV</button>
                <div class="tiny">Si el n¬∫ de equipos no es potencia de 2, se completa con BYE.</div>
              </div>
              <div id="statusBracket" class="tiny" style="margin-top:8px"></div>
            </div>
          </div>
          <div class="card" style="margin-top:12px">
            <h3>Resultado</h3>
            <div id="resultBracket" class="grid"></div>
          </div>
        </div>
      </div>

      <div class="tiny" style="margin-top:12px">Hecho con ‚ù§Ô∏è. Todo ocurre del lado del cliente. Pod√©s guardar y compartir con "üîó Compartir".</div>
    </div>
  </section>

<script>
// C√≥digo JavaScript simplificado y funcional - VERSI√ìN ESTABLE
'use strict';

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAg7CKq8cMD7WZXJSKylls5JJS4juvxi54",
  authDomain: "sorteador-53cb5.firebaseapp.com",
  projectId: "sorteador-53cb5",
  storageBucket: "sorteador-53cb5.firebasestorage.app",
  messagingSenderId: "583913752340",
  appId: "1:583913752340:web:347f8b2866fcbb216e6401"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Estado simple
let activeTeams = [];
let inactiveTeams = [];
let lastResult = null;

// Funciones b√°sicas
function toast(msg) {
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.cssText = 'position:fixed;bottom:16px;right:16px;background:#111827;border:1px solid #334155;padding:10px 12px;border-radius:10px;z-index:9999;';
  document.body.appendChild(el); 
  setTimeout(() => el.remove(), 1500);
}

function escapeHtml(text) {
  const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}; 
  return text.replace(/[&<>"']/g, m => map[m]);
}

// Auth event listeners
document.addEventListener('DOMContentLoaded', function() {
  // Tabs auth
  document.querySelectorAll('.authTab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.authTab').forEach(t => t.classList.remove('active'));
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.add('hidden');
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab + 'Form').classList.remove('hidden');
    });
  });

  // Registro
  document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('registerName').value.trim();
    const email = document.getElementById('registerEmail').value.trim();
    const pass = document.getElementById('registerPassword').value;
    const pass2 = document.getElementById('registerConfirmPassword').value;
    
    if (pass !== pass2) { 
      toast('Las contrase√±as no coinciden'); 
      return; 
    }
    
    try {
      const cred = await auth.createUserWithEmailAndPassword(email, pass);
      await cred.user.updateProfile({ displayName: name });
      toast('Cuenta creada exitosamente');
    } catch(err) { 
      toast('Error: ' + err.message); 
    }
  });

  // Login
  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPassword').value;
    
    try {
      await auth.signInWithEmailAndPassword(email, pass);
      toast('Sesi√≥n iniciada');
    } catch(err) { 
      toast('Error: ' + err.message); 
    }
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    try { 
      await auth.signOut(); 
      toast('Sesi√≥n cerrada'); 
    } catch { 
      toast('Error al cerrar sesi√≥n'); 
    }
  });
});

// Auth state changes
auth.onAuthStateChanged((user) => {
  const authSection = document.getElementById('authSection');
  const appSection = document.getElementById('appSection');
  const userInfo = document.getElementById('userInfo');
  
  if (user) {
    authSection.classList.add('hidden');
    appSection.classList.remove('hidden');
    userInfo.textContent = user.displayName ? user.displayName : (user.email || 'Usuario');
    toast('¬°Bienvenido!');
  } else {
    appSection.classList.add('hidden');
    authSection.classList.remove('hidden');
    userInfo.textContent = '';
  }
});
</script>
</body>
</html>
