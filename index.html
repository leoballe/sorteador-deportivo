<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sorteador Deportivo</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--card:#1f2937;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent2:#38bdf8;--danger:#ef4444;--warn:#f59e0b}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    a{color:var(--accent2)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:clamp(22px,3vw,30px);margin:0}
    .badge{font-size:12px;background:#0b2;opacity:.9;padding:4px 8px;border-radius:999px}
    .panel{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #243042;border-radius:14px;padding:14px}
    .card h3{margin:0 0 8px 0;font-size:16px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=number],textarea,select{width:100%;background:#0b1220;color:var(--text);border:1px solid #223046;border-radius:10px;padding:10px;font-size:14px}
    textarea{min-height:200px;resize:vertical}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{background:#0b1220;color:var(--text);border:1px solid #223046;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn:hover{border-color:#3b82f6}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#16a34a);border:0;color:#052e16}
    .btn.ghost{background:transparent;border-color:#2b3b55}
    .btn.warn{background:linear-gradient(135deg,var(--warn),#d97706);border:0;color:#3b1d00}
    .btn.danger{background:linear-gradient(135deg,var(--danger),#dc2626);border:0;color:#450a0a}
    .tiny{font-size:12px;color:var(--muted)}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:10px;border:1px solid #223046;background:#0b1220;cursor:pointer;color:#e5e7eb}
    .tab.active{background:#0a3622;border-color:#1b5e3b;color:#22c55e}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
    .zone{background:#0b1220;border:1px solid #223046;border-radius:14px;padding:10px}
    .zone h4{margin:4px 0 8px 0}
    .zone ol{margin:0;padding-left:18px}
    .muted{color:var(--muted)}
    .warnText{color:var(--warn)}
    .errorText{color:var(--danger)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border:1px solid #2b3b55;border-radius:999px;background:#0b1220}
    .hidden{display:none}
    .history{display:grid;gap:8px}
    .history .item{background:#0b1220;border:1px dashed #2b3b55;padding:8px;border-radius:10px;font-size:13px}
    .listWrap{display:grid;grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:900px){.listWrap{grid-template-columns:1fr}}
    .listBox{background:#0b1220;border:1px dashed #2b3b55;border-radius:12px;padding:10px;min-height:120px}
    .listBox h4{margin:2px 0 8px 0;font-size:14px}
    .itemRow{display:flex;align-items:center;gap:8px;padding:4px 6px;border-bottom:1px dashed #1f2a3b}
    .itemRow:last-child{border-bottom:none}
    .tag{font-size:11px;color:#cbd5e1;border:1px solid #334155;border-radius:999px;padding:1px 6px}
    .savedDrawItem{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#0b1220;border:1px solid #223046;border-radius:10px;margin-bottom:8px}
    .savedDrawInfo{flex:1}
    .savedDrawActions{display:flex;gap:6px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>üé≤ Sorteador Deportivo</h1>
        <div class="tiny">Funciona 100% en tu navegador (sin backend).</div>
      </div>
      <span class="badge">v3.3</span>
    </header>

    <div class="panel">
      <div class="tabs">
        <button class="tab active" data-tab="grupos" type="button">Zonas / Grupos</button>
        <button class="tab" data-tab="simple" type="button">Sorteo simple</button>
        <button class="tab" data-tab="bracket" type="button">Eliminaci√≥n directa (beta)</button>
        <button class="tab" data-tab="saved" type="button">üìä Sorteos realizados</button>
      </div>

      <div id="tab-grupos" class="tabcontent">
        <div class="row">
          <div class="card">
            <h3>Equipos</h3>
            <label>Peg√° la lista (una l√≠nea por equipo). Opcional: <span class="pill">; Provincia</span> y <span class="pill">; *</span> para cabeza.</label>
            <textarea id="teamsInput" placeholder="Ejemplos:
River Plate; CABA; *
Boca Juniors; CABA
Newell's; Santa Fe
..."></textarea>
            <div class="controls" style="margin-top:8px">
              <label for="csvFile" class="btn ghost">üìÑ Importar CSV de equipos</label>
              <input id="csvFile" type="file" accept=".csv,text/csv" class="hidden" />
              <button class="btn ghost" id="btnExample" type="button">Cargar ejemplo</button>
              <button class="btn ghost" id="btnClear" type="button">Limpiar</button>
              <button class="btn" id="btnBuildList" type="button">üóÇÔ∏è Mostrar lista con checks</button>
            </div>
            <div class="tiny">CSV de equipos: <b>Equipo, Provincia, Cabeza</b> ("s√≠" para cabeza). Acepta <b>,</b>, <b>;</b> o <b>TAB</b>, con o sin cabecera.</div>
            <div id="csvInfo" class="tiny" style="margin-top:6px"></div>

            <div id="checkLists" class="listWrap hidden" style="margin-top:10px">
              <div class="listBox">
                <h4>Activos (participan) <span class="tag" id="countActive">0</span></h4>
                <div class="controls" style="margin-bottom:6px">
                  <button class="btn tiny" id="btnSelectAllActive" type="button">Seleccionar todo</button>
                  <button class="btn warn tiny" id="btnMoveToInactive" type="button">Descartar seleccionados ‚ûú</button>
                </div>
                <div id="activeList"></div>
              </div>
              <div class="listBox">
                <h4>Descartados <span class="tag" id="countInactive">0</span></h4>
                <div class="controls" style="margin-bottom:6px">
                  <label class="pill"><input type="checkbox" id="toggleShowInactive"> Mostrar descartados</label>
                  <button class="btn tiny" id="btnSelectAllInactive" type="button">Seleccionar todo</button>
                  <button class="btn primary tiny" id="btnRestoreSelected" type="button">‚¨Ö Restaurar seleccionados</button>
                </div>
                <div id="inactiveList" class="hidden"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Par√°metros</h3>
            <div class="controls" id="formatRow">
              <label class="pill"><input type="radio" name="format" value="8x3" checked> 8 zonas de 3</label>
              <label class="pill"><input type="radio" name="format" value="4x6"> 4 zonas de 6</label>
              <label class="pill"><input type="radio" name="format" value="custom"> Personalizado</label>
            </div>
            <div class="controls">
              <div style="min-width:160px;flex:1">
                <label>N¬∫ de zonas / grupos</label>
                <input type="number" id="zones" min="1" value="8" />
              </div>
              <div style="min-width:220px;flex:1">
                <label>Disciplina</label>
                <select id="disciplineSelect">
                  <option value="">‚Äî Seleccionar disciplina ‚Äî</option>
                </select>
              </div>
            </div>
            <div class="controls">
              <div style="min-width:220px;flex:1">
                <label>Categor√≠a</label>
                <select id="categorySelect">
                  <option value="">‚Äî Seleccionar categor√≠a ‚Äî</option>
                </select>
              </div>
              <div style="min-width:220px;flex:1">
                <label>G√©nero</label>
                <select id="genderSelect">
                  <option value="">‚Äî Seleccionar g√©nero ‚Äî</option>
                  <option value="Masculino">Masculino</option>
                  <option value="Femenino">Femenino</option>
                  <option value="Mixto">Mixto</option>
                  <option value="No Aplica">No Aplica</option>
                </select>
              </div>
            </div>
            <div class="controls">
              <label for="csvDisciplines" class="btn ghost">üìÑ Importar CSV de disciplinas</label>
              <input id="csvDisciplines" type="file" accept=".csv,text/csv" class="hidden" />
              <button class="btn ghost" id="btnDiscDemo" type="button">Cargar disciplinas demo</button>
              <label for="csvCategories" class="btn ghost">üìÑ Importar CSV de categor√≠as</label>
              <input id="csvCategories" type="file" accept=".csv,text/csv" class="hidden" />
              <button class="btn ghost" id="btnCatDemo" type="button">Cargar categor√≠as demo</button>
            </div>
            <div id="discCSVInfo" class="tiny" style="margin-top:4px"></div>
            <div id="catCSVInfo" class="tiny" style="margin-top:4px"></div>

            <label><input type="checkbox" id="headsAsFirst" checked> Cabezas de serie primero</label>
            <div id="capInfo" class="tiny" style="margin-top:6px"></div>

            <div class="controls" style="margin-top:10px">
              <button class="btn primary" id="btnDrawGroups" type="button">üéØ SORTEAR ZONAS</button>
              <button class="btn" id="btnExportCSV" type="button">‚¨áÔ∏è Exportar CSV</button>
              <button class="btn" id="btnCopy" type="button">üìã Copiar</button>
              <button class="btn" id="btnShare" type="button">üîó Compartir</button>
            </div>
            <div id="status" class="tiny" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Resultado</h3>
          <div id="resultGroups" class="grid"></div>
        </div>
      </div>

      <div id="tab-simple" class="tabcontent hidden">
        <div class="row">
          <div class="card">
            <h3>Equipos</h3>
            <label>Usa la lista del tab Grupos (o peg√° otra):</label>
            <textarea id="simpleInput" placeholder="Uno por l√≠nea..."></textarea>
            <div class="controls" style="margin-top:8px">
              <button class="btn ghost" id="btnUseFromGroups" type="button">Usar lista del tab Grupos</button>
              <button class="btn ghost" id="btnClearSimple" type="button">Limpiar</button>
            </div>
          </div>
          <div class="card">
            <h3>Par√°metros</h3>
            <div class="controls">
              <div style="min-width:220px;flex:1">
                <label>Disciplina</label>
                <select id="disciplineSelectSimple">
                  <option value="">‚Äî Seleccionar disciplina ‚Äî</option>
                </select>
              </div>
            </div>
            <div class="controls" style="margin-top:10px">
              <button class="btn primary" id="btnDrawSimple" type="button">üé≤ SORTEAR ORDEN</button>
              <button class="btn" id="btnExportSimple" type="button">‚¨áÔ∏è Exportar CSV</button>
              <button class="btn" id="btnCopySimple" type="button">üìã Copiar</button>
              <button class="btn" id="btnExportPDFSimple" type="button">üñ®Ô∏è Exportar PDF</button>
            </div>
            <div id="statusSimple" class="tiny" style="margin-top:8px"></div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>Resultado</h3>
          <div id="resultSimple"></div>
        </div>
      </div>

      <div id="tab-bracket" class="tabcontent hidden">
        <div class="row">
          <div class="card">
            <h3>Equipos</h3>
            <label>Usa la lista del tab Grupos (o peg√° otra):</label>
            <textarea id="bracketInput" placeholder="Uno por l√≠nea..."></textarea>
            <div class="controls" style="margin-top:8px">
              <button class="btn ghost" id="btnUseFromGroups2" type="button">Usar lista del tab Grupos</button>
              <button class="btn ghost" id="btnClearBracket" type="button">Limpiar</button>
            </div>
          </div>
          <div class="card">
            <h3>Par√°metros</h3>
            <div class="controls">
              <div style="min-width:220px;flex:1">
                <label>Disciplina</label>
                <select id="disciplineSelectBracket">
                  <option value="">‚Äî Seleccionar disciplina ‚Äî</option>
                </select>
              </div>
            </div>
            <div class="controls" style="margin-top:10px">
              <button class="btn primary" id="btnDrawBracket" type="button">ü•ä Generar llaves</button>
              <button class="btn" id="btnExportBracket" type="button">‚¨áÔ∏è Exportar CSV</button>
              <div class="tiny">Si el n¬∫ de equipos no es potencia de 2, se completa con BYE.</div>
            </div>
            <div id="statusBracket" class="tiny" style="margin-top:8px"></div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>Resultado</h3>
          <div id="resultBracket" class="grid"></div>
        </div>
      </div>

      <div id="tab-saved" class="tabcontent hidden">
        <div class="card">
          <h3>üìä Sorteos Realizados</h3>
          <div class="tiny" style="margin-bottom:12px">
            Los sorteos se guardan autom√°ticamente en tu navegador actual. 
            <span class="warnText">No se comparten entre diferentes navegadores.</span>
          </div>
          <div class="controls" style="margin-bottom:12px">
            <button class="btn danger" id="btnClearAllSaved" type="button">üóëÔ∏è Eliminar todos los sorteos</button>
            <button class="btn" id="btnExportAllSaved" type="button">üíæ Exportar todos</button>
            <label for="importSaved" class="btn ghost">üìÇ Importar sorteos</label>
            <input id="importSaved" type="file" accept=".json" class="hidden" />
          </div>
          <div id="savedDrawsList"></div>
        </div>
      </div>
    </div>

    <div class="tiny" style="margin-top:12px">Hecho con ‚ù§Ô∏è. Todo ocurre del lado del cliente (no se sube nada). Pod√©s guardar y compartir con "üîó Compartir".</div>
  </div>

<script>
'use strict';

// ====================== CONFIGURACI√ìN INICIAL ======================
let activeTeams = [];
let inactiveTeams = [];
let disciplines = [];
let categories = [];
let currentResult = null; // ‚Üê NUEVO: Para controlar el resultado actual

// ====================== SISTEMA DE ALMACENAMIENTO MEJORADO ======================
const STORAGE_KEY = 'savedDraws_v3';

// Verificar si localStorage est√° disponible de forma m√°s robusta
function isLocalStorageAvailable() {
  try {
    const test = 'test';
    localStorage.setItem(test, test);
    localStorage.removeItem(test);
    return true;
  } catch (e) {
    console.warn('localStorage no disponible:', e);
    return false;
  }
}

// Sistema de fallback para cuando localStorage no est√° disponible
let memoryStorage = {};

function saveDraw(type, parameters, result) {
  const draw = {
    id: Date.now(),
    type,
    parameters,
    result,
    date: new Date().toLocaleString()
  };
  
  if (isLocalStorageAvailable()) {
    try {
      const savedDraws = getSavedDraws();
      savedDraws.unshift(draw);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(savedDraws));
      console.log('Sorteo guardado en localStorage:', draw);
      return draw;
    } catch (error) {
      console.error('Error guardando en localStorage, usando memoria:', error);
      // Fallback a memoria
      memoryStorage[draw.id] = draw;
      return draw;
    }
  } else {
    // Fallback a memoria
    console.log('Sorteo guardado en memoria:', draw);
    memoryStorage[draw.id] = draw;
    return draw;
  }
}

function getSavedDraws() {
  if (isLocalStorageAvailable()) {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      return saved ? JSON.parse(saved) : [];
    } catch (error) {
      console.error('Error cargando de localStorage, usando memoria:', error);
      return Object.values(memoryStorage).sort((a, b) => b.id - a.id);
    }
  } else {
    return Object.values(memoryStorage).sort((a, b) => b.id - a.id);
  }
}

function deleteDraw(id) {
  if (isLocalStorageAvailable()) {
    try {
      const savedDraws = getSavedDraws();
      const filtered = savedDraws.filter(draw => draw.id !== id);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(filtered));
    } catch (error) {
      console.error('Error eliminando de localStorage:', error);
    }
  }
  
  // Siempre eliminar de memoria tambi√©n
  delete memoryStorage[id];
  renderSavedDraws();
  toast('Sorteo eliminado');
}

function clearAllSavedDraws() {
  if (confirm('¬øEst√°s seguro de que quer√©s eliminar todos los sorteos guardados? Esta acci√≥n no se puede deshacer.')) {
    if (isLocalStorageAvailable()) {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (error) {
        console.error('Error eliminando de localStorage:', error);
      }
    }
    
    // Limpiar memoria tambi√©n
    memoryStorage = {};
    renderSavedDraws();
    toast('Todos los sorteos han sido eliminados');
  }
}

function exportAllSavedDraws() {
  const savedDraws = getSavedDraws();
  if (savedDraws.length === 0) {
    toast('No hay sorteos para exportar');
    return;
  }
  
  const dataStr = JSON.stringify(savedDraws, null, 2);
  const blob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `sorteos_guardados_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast('Sorteos exportados correctamente');
}

function importSavedDraws(file) {
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedDraws = JSON.parse(e.target.result);
      if (!Array.isArray(importedDraws)) {
        throw new Error('Formato de archivo inv√°lido');
      }
      
      const savedDraws = getSavedDraws();
      const existingIds = new Set(savedDraws.map(d => d.id));
      
      let importedCount = 0;
      importedDraws.forEach(draw => {
        if (!existingIds.has(draw.id)) {
          savedDraws.push(draw);
          if (memoryStorage) memoryStorage[draw.id] = draw;
          importedCount++;
        }
      });
      
      if (isLocalStorageAvailable()) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedDraws));
      }
      
      renderSavedDraws();
      toast(`${importedCount} sorteos importados correctamente`);
      
    } catch (error) {
      console.error('Error importando sorteos:', error);
      alert('Error al importar sorteos: ' + error.message);
    }
  };
  reader.readAsText(file);
}

function renderSavedDraws() {
  const container = document.getElementById('savedDrawsList');
  const savedDraws = getSavedDraws();
  
  if (!isLocalStorageAvailable()) {
    const warning = document.createElement('div');
    warning.className = 'warnText';
    warning.style.marginBottom = '12px';
    warning.innerHTML = '‚ö†Ô∏è El almacenamiento local no est√° disponible. Los sorteos se guardar√°n solo en esta sesi√≥n.';
    if (!container.previousElementSibling || !container.previousElementSibling.classList.contains('warnText')) {
      container.parentNode.insertBefore(warning, container);
    }
  }
  
  if (savedDraws.length === 0) {
    container.innerHTML = '<div class="muted">No hay sorteos guardados a√∫n.</div>';
    return;
  }
  
  container.innerHTML = savedDraws.map(draw => `
    <div class="savedDrawItem">
      <div class="savedDrawInfo">
        <div><b>${draw.type === 'grupos' ? 'üèÜ Sorteo de Zonas' : 'üé≤ Sorteo Simple'}</b></div>
        <div class="tiny">
          ${draw.parameters.discipline ? draw.parameters.discipline + ' ‚Ä¢ ' : ''}
          ${draw.parameters.category ? draw.parameters.category + ' ‚Ä¢ ' : ''}
          ${draw.parameters.gender ? draw.parameters.gender + ' ‚Ä¢ ' : ''}
          ${draw.date}
        </div>
        <div class="tiny">
          ${draw.type === 'grupos' ? 
            `${draw.result.groups.length} zonas ‚Ä¢ ${draw.result.groups.flat().length} equipos` : 
            `${draw.result.list.length} equipos`
          }
        </div>
      </div>
      <div class="savedDrawActions">
        <button class="btn tiny" onclick="openSavedDraw(${draw.id})">Abrir</button>
        <button class="btn danger tiny" onclick="deleteDraw(${draw.id})">Eliminar</button>
      </div>
    </div>
  `).join('');
}

function openSavedDraw(id) {
  const savedDraws = getSavedDraws();
  const draw = savedDraws.find(d => d.id === id);
  if (!draw) {
    toast('Sorteo no encontrado');
    return;
  }
  
  if (draw.type === 'grupos') {
    openResultInNewTab(draw.result, draw.parameters);
  } else if (draw.type === 'simple') {
    openSimpleResultInNewTab(draw.result, draw.parameters);
  }
}

// ====================== CORRECCI√ìN DEFINITIVA DEL PROBLEMA DE ACTUALIZACI√ìN ======================

// Funci√≥n para limpiar resultados cuando cambian los par√°metros
function clearResults() {
  document.getElementById('resultGroups').innerHTML = '';
  document.getElementById('status').innerHTML = '';
  document.getElementById('resultSimple').innerHTML = '';
  document.getElementById('statusSimple').innerHTML = '';
  currentResult = null; // ‚Üê Limpiar el resultado actual
}

// Funci√≥n mejorada para verificar si los par√°metros cambiaron
function haveParametersChanged() {
  // Si no hay resultado actual, entonces no hay cambios
  if (!currentResult) return true;
  
  const currentDiscipline = document.getElementById('disciplineSelect').value;
  const currentCategory = document.getElementById('categorySelect').value;
  const currentGender = document.getElementById('genderSelect').value;
  
  // Comparar con los par√°metros del resultado actual
  return currentDiscipline !== currentResult.parameters.discipline ||
         currentCategory !== currentResult.parameters.category ||
         currentGender !== currentResult.parameters.gender;
}

// ====================== UTILIDADES B√ÅSICAS ======================
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

function toast(msg) {
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.cssText = 'position:fixed;bottom:16px;right:16px;background:#111827;border:1px solid #334155;padding:10px 12px;border-radius:10px;z-index:9999;';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1500);
}

function downloadText(text, filename) {
  const blob = new Blob([text], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

function copyText(text) {
  navigator.clipboard.writeText(text)
    .then(() => toast('Copiado'))
    .catch(() => alert('No se pudo copiar'));
}

// ====================== PARSERS DE CSV ======================
function parseCSV(text) {
  if (!text.trim()) return {headers: [], rows: []};
  
  // Detectar delimitador
  const firstLine = text.split('\n')[0];
  const delimiters = [',', ';', '\t'];
  let bestDelimiter = ',';
  let maxCount = 0;
  
  for (const delim of delimiters) {
    const count = (firstLine.match(new RegExp(delim, 'g')) || []).length;
    if (count > maxCount) {
      maxCount = count;
      bestDelimiter = delim;
    }
  }
  
  const lines = text.split(/\r?\n/).filter(line => line.trim());
  const headers = parseCSVLine(lines[0], bestDelimiter);
  const rows = lines.slice(1).map(line => parseCSVLine(line, bestDelimiter));
  
  return {headers, rows, delimiter: bestDelimiter};
}

function parseCSVLine(line, delimiter) {
  const result = [];
  let current = '';
  let inQuotes = false;
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    const nextChar = line[i + 1];
    
    if (char === '"') {
      if (inQuotes && nextChar === '"') {
        current += '"';
        i++;
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === delimiter && !inQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  
  result.push(current.trim());
  return result;
}

// ====================== IMPORTACI√ìN DE EQUIPOS ======================
function importTeamsCSV(text) {
  try {
    // Limpiar BOM si existe
    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    
    const {headers, rows, delimiter} = parseCSV(text);
    
    console.log('=== DEBUG CSV PARSING ===');
    console.log('Headers:', headers);
    console.log('First row:', rows[0]);
    
    // DETECCI√ìN INTELIGENTE de columnas
    let nameIdx = -1, provinceIdx = -1, headIdx = -1;
    
    if (headers.length > 0) {
      headers.forEach((header, idx) => {
        const h = header.toLowerCase().trim();
        
        // Buscar columna de NOMBRE (la m√°s importante)
        if (nameIdx === -1 && (
          h.includes('equipo') || h.includes('team') || h.includes('nombre') || 
          h.includes('club') || h.includes('instituci√≥n') || h === 'nombre'
        )) {
          nameIdx = idx;
          console.log('Columna NOMBRE detectada:', idx, header);
        }
        
        // Buscar columna de PROVINCIA
        if (provinceIdx === -1 && (
          h.includes('provincia') || h.includes('province') || h.includes('regi√≥n') ||
          h.includes('region') || h.includes('localidad') || h === 'provincia'
        )) {
          provinceIdx = idx;
          console.log('Columna PROVINCIA detectada:', idx, header);
        }
        
        // Buscar columna de CABEZA
        if (headIdx === -1 && (
          h.includes('cabeza') || h.includes('head') || h.includes('seed') ||
          h.includes('semilla') || h.includes('cabezas') || h === 'cabeza'
        )) {
          headIdx = idx;
          console.log('Columna CABEZA detectada:', idx, header);
        }
      });
    }
    
    // FALLBACK: Si no detect√≥ columnas, usar las primeras 3
    if (nameIdx === -1) {
      nameIdx = 0;
      provinceIdx = headers.length > 1 ? 1 : -1;
      headIdx = headers.length > 2 ? 2 : -1;
      console.log('Usando columnas por defecto:', {nameIdx, provinceIdx, headIdx});
    }
    
    const teams = [];
    const uniqueNames = new Set();
    
    for (const row of rows) {
      if (row.length <= nameIdx) continue;
      
      const name = (row[nameIdx] || '').replace(/\*+$/, '').trim();
      if (!name) continue;
      
      // Verificar duplicados
      if (uniqueNames.has(name.toLowerCase())) {
        console.log('Duplicado ignorado:', name);
        continue;
      }
      uniqueNames.add(name.toLowerCase());
      
      const province = (provinceIdx !== -1 && row[provinceIdx]) ? 
                      row[provinceIdx].replace(/\*+$/, '').trim() : '';
      
      const headValue = (headIdx !== -1 && row[headIdx]) ? 
                       row[headIdx].toLowerCase().trim() : '';
      
      const head = /^(si|s√≠|true|1|\*|x|head|seed|cs)$/.test(headValue) || 
                  (row[nameIdx] || '').includes('*');
      
      teams.push({name, province, head});
      console.log('Equipo procesado:', {name, province, head});
    }
    
    console.log('Total equipos √∫nicos:', teams.length);
    return {teams, delimiter, hasHeaders: headers.length > 0};
    
  } catch (error) {
    console.error('Error importando equipos:', error);
    throw new Error('No se pudo leer el CSV de equipos: ' + error.message);
  }
}

// ====================== IMPORTACI√ìN DE DISCIPLINAS ======================
function importDisciplinesCSV(text) {
  try {
    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    
    const {headers, rows, delimiter} = parseCSV(text);
    
    let nameIdx = 0, seedIdx = 1;
    
    if (headers.length > 0) {
      headers.forEach((header, idx) => {
        const h = header.toLowerCase();
        if (h.includes('disciplina') || h.includes('deporte') || h.includes('nombre')) nameIdx = idx;
        if (h.includes('semilla') || h.includes('seed') || h.includes('c√≥digo')) seedIdx = idx;
      });
    }
    
    const items = [];
    for (const row of rows) {
      if (row.length <= nameIdx) continue;
      
      const name = (row[nameIdx] || '').trim();
      if (!name) continue;
      
      const seed = (row[seedIdx] || name).trim();
      items.push({name, seed});
    }
    
    return {items, delimiter, hasHeaders: headers.length > 0};
  } catch (error) {
    console.error('Error importando disciplinas:', error);
    throw new Error('No se pudo leer el CSV de disciplinas');
  }
}

// ====================== IMPORTACI√ìN DE CATEGOR√çAS ======================
function importCategoriesCSV(text) {
  try {
    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    
    const {headers, rows, delimiter} = parseCSV(text);
    
    let nameIdx = 0, seedIdx = 1;
    
    if (headers.length > 0) {
      headers.forEach((header, idx) => {
        const h = header.toLowerCase();
        if (h.includes('categor√≠a') || h.includes('category') || h.includes('divisi√≥n')) nameIdx = idx;
        if (h.includes('semilla') || h.includes('seed') || h.includes('c√≥digo')) seedIdx = idx;
      });
    }
    
    const items = [];
    for (const row of rows) {
      if (row.length <= nameIdx) continue;
      
      const name = (row[nameIdx] || '').trim();
      if (!name) continue;
      
      const seed = (row[seedIdx] || name).trim();
      items.push({name, seed});
    }
    
    return {items, delimiter, hasHeaders: headers.length > 0};
  } catch (error) {
    console.error('Error importando categor√≠as:', error);
    throw new Error('No se pudo leer el CSV de categor√≠as');
  }
}

// ====================== GESTI√ìN DE SELECTORES ======================
function refreshDisciplineSelects() {
  const selects = [
    document.getElementById('disciplineSelect'),
    document.getElementById('disciplineSelectSimple'),
    document.getElementById('disciplineSelectBracket')
  ];
  
  selects.forEach(select => {
    if (!select) return;
    
    // Guardar selecci√≥n actual
    const currentValue = select.value;
    
    // Limpiar opciones
    select.innerHTML = '<option value="">‚Äî Seleccionar disciplina ‚Äî</option>';
    
    // Agregar disciplinas
    disciplines.forEach(d => {
      const option = document.createElement('option');
      option.value = d.seed;
      option.textContent = d.name;
      option.dataset.seed = d.seed;
      select.appendChild(option);
    });
    
    // Restaurar selecci√≥n si existe
    if (currentValue && [...select.options].some(opt => opt.value === currentValue)) {
      select.value = currentValue;
    }
  });
}

function refreshCategorySelects() {
  const select = document.getElementById('categorySelect');
  if (!select) return;
  
  const currentValue = select.value;
  select.innerHTML = '<option value="">‚Äî Seleccionar categor√≠a ‚Äî</option>';
  
  categories.forEach(c => {
    const option = document.createElement('option');
    option.value = c.name;
    option.textContent = c.name;
    option.dataset.seed = c.seed;
    select.appendChild(option);
  });
  
  if (currentValue && [...select.options].some(opt => opt.value === currentValue)) {
    select.value = currentValue;
  }
}

// ====================== GESTI√ìN DE LISTAS ACTIVAS/INACTIVAS ======================
function buildListsFromTextarea() {
  const text = document.getElementById('teamsInput').value;
  const lines = text.split(/\r?\n/).filter(line => line.trim());
  
  // LIMPIAR COMPLETAMENTE antes de empezar
  activeTeams = [];
  inactiveTeams = [];
  
  const uniqueNames = new Set(); // ‚Üê Para controlar duplicados
  
  lines.forEach(line => {
    if (!line.trim()) return;
    
    const parts = line.split(';').map(p => p.trim());
    const name = parts[0].replace(/\*+$/, '').trim();
    
    if (!name) return;
    
    // ‚Üê CR√çTICO: Verificar duplicado
    if (uniqueNames.has(name.toLowerCase())) {
      console.log('Duplicado ignorado:', name);
      return;
    }
    uniqueNames.add(name.toLowerCase());
    
    const province = (parts[1] || '').replace(/\*+$/, '').trim();
    const head = parts[2] ? /^(si|s√≠|true|1|\*|x)$/i.test(parts[2]) : 
                parts[0].includes('*');
    
    activeTeams.push({name, province, head});
  });
  
  document.getElementById('checkLists').classList.remove('hidden');
  renderLists();
  updateCapInfo();
  toast(`Lista cargada: ${activeTeams.length} equipos √∫nicos`);
}

function renderLists() {
  const activeList = document.getElementById('activeList');
  const inactiveList = document.getElementById('inactiveList');
  const showInactive = document.getElementById('toggleShowInactive').checked;
  
  document.getElementById('countActive').textContent = activeTeams.length;
  document.getElementById('countInactive').textContent = inactiveTeams.length;
  
  inactiveList.classList.toggle('hidden', !showInactive);
  
  // Render lista activa
  activeList.innerHTML = '';
  activeTeams.forEach((team, idx) => {
    const row = document.createElement('div');
    row.className = 'itemRow';
    row.innerHTML = `
      <input type="checkbox" class="chkActive" data-idx="${idx}">
      <b>${escapeHtml(team.name)}</b>
      ${team.province ? `<span class="muted">‚Äî ${escapeHtml(team.province)}</span>` : ''}
      ${team.head ? '<span class="pill">Cabeza</span>' : ''}
    `;
    activeList.appendChild(row);
  });
  
  // Render lista inactiva
  inactiveList.innerHTML = '';
  inactiveTeams.forEach((team, idx) => {
    const row = document.createElement('div');
    row.className = 'itemRow';
    row.innerHTML = `
      <input type="checkbox" class="chkInactive" data-idx="${idx}">
      <b>${escapeHtml(team.name)}</b>
      ${team.province ? `<span class="muted">‚Äî ${escapeHtml(team.province)}</span>` : ''}
      ${team.head ? '<span class="pill">Cabeza</span>' : ''}
    `;
    inactiveList.appendChild(row);
  });
}

function getChecked(selector) {
  return Array.from(document.querySelectorAll(selector))
    .map(el => parseInt(el.dataset.idx))
    .filter(idx => !isNaN(idx))
    .sort((a, b) => b - a);
}

function moveSelectedToInactive() {
  const indices = getChecked('.chkActive:checked');
  const moved = indices.map(idx => activeTeams[idx]);
  
  indices.forEach(idx => activeTeams.splice(idx, 1));
  inactiveTeams.unshift(...moved);
  
  renderLists();
  updateCapInfo();
}

function restoreSelectedFromInactive() {
  const indices = getChecked('.chkInactive:checked');
  const moved = indices.map(idx => inactiveTeams[idx]);
  
  indices.forEach(idx => inactiveTeams.splice(idx, 1));
  activeTeams.push(...moved);
  
  renderLists();
  updateCapInfo();
}

function selectAll(selector) {
  document.querySelectorAll(selector).forEach(cb => cb.checked = true);
}

function getActiveTeamsLive() {
  if (document.getElementById('checkLists').classList.contains('hidden')) {
    const text = document.getElementById('teamsInput').value;
    const lines = text.split(/\r?\n/).filter(line => line.trim());
    const teams = [];
    const uniqueNames = new Set(); // ‚Üê Para controlar duplicados
    
    lines.forEach(line => {
      const parts = line.split(';').map(p => p.trim());
      const name = parts[0].replace(/\*+$/, '').trim();
      
      if (!name) return;
      
      // ‚Üê CR√çTICO: Verificar duplicado
      if (uniqueNames.has(name.toLowerCase())) return;
      uniqueNames.add(name.toLowerCase());
      
      teams.push({
        name: name,
        province: parts[1] ? parts[1].replace(/\*+$/, '').trim() : '',
        head: parts[2] ? /^(si|s√≠|true|1|\*|x)$/i.test(parts[2]) : parts[0].includes('*')
      });
    });
    
    return teams;
  }
  return [...activeTeams];
}

// ====================== SISTEMA DE SORTEO ======================
function xmur3(str) {
  let h = 1779033703 ^ str.length;
  for (let i = 0; i < str.length; i++) {
    h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
    h = h << 13 | h >>> 19;
  }
  return function() {
    h = Math.imul(h ^ h >>> 16, 2246822507);
    h = Math.imul(h ^ h >>> 13, 3266489909);
    return (h ^ h >>> 16) >>> 0;
  };
}

function mulberry32(a) {
  return function() {
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ t >>> 15, t | 1);
    t ^= t + Math.imul(t ^ t >>> 7, t | 61);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  };
}

function rngFromSeed(seed) {
  if (!seed || seed.trim() === "") return Math.random;
  const h = xmur3(String(seed))();
  return mulberry32(h);
}

function shuffle(array, rand) {
  const a = [...array];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(rand() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function capacities(n, z) {
  const base = Math.floor(n / z);
  const rest = n % z;
  return Array.from({length: z}, (_, i) => base + (i < rest ? 1 : 0));
}

function capacitiesFourBySix(n) {
  const caps = [6, 6, 6, 6];
  const total = 24;
  if (n >= total) return caps;
  
  let deficits = total - n;
  const order = [3, 1, 2, 0];
  let i = 0;
  
  while (deficits > 0) {
    const idx = order[i % order.length];
    if (caps[idx] > 0) {
      caps[idx]--;
      deficits--;
    }
    i++;
  }
  return caps;
}

function capacitiesEightByThree(n) {
  const caps = Array(8).fill(3);
  const total = 24;
  if (n >= total) return caps;
  
  const d = total - n;
  const zeros = Math.floor(d / 3);
  const twos = d % 3;
  const order = [7, 6, 5, 4, 3, 2, 1, 0];
  
  for (let i = 0; i < zeros; i++) caps[order[i]] = 0;
  
  let k = zeros;
  for (let j = 0; j < twos && k < order.length; j++, k++) {
    if (caps[order[k]] === 3) caps[order[k]] = 2;
  }
  
  return caps;
}

function drawGroups(teams, z, headsAsFirst, seed, format) {
  const rand = rngFromSeed(seed);
  const n = teams.length;
  
  if (z < 1) return {error: 'El n¬∫ de zonas debe ser ‚â• 1'};
  if (n < z) return {error: 'Hay menos equipos que zonas.'};
  
  const capsBase = (format === '4x6' && z === 4 && n <= 24) ? capacitiesFourBySix(n) :
                  (format === '8x3' && z === 8 && n <= 24) ? capacitiesEightByThree(n) :
                  capacities(n, z);
  
  const groups = Array.from({length: z}, () => []);
  const heads = shuffle(teams.filter(t => t.head), rand);
  const others = shuffle(teams.filter(t => !t.head), rand);
  
  if (headsAsFirst && heads.length) {
    for (let i = 0; i < groups.length && i < heads.length; i++) {
      groups[i].push(heads[i]);
    }
  }
  
  const targetCaps = capsBase.map((cap, i) => Math.max(0, cap - groups[i].length));
  const pool = headsAsFirst ? others : shuffle(teams, rand);
  
  const maxAttempts = 500;
  for (let attempt = 0; attempt < maxAttempts; attempt++) {
    const g = groups.map(arr => [...arr]);
    const remaining = [...targetCaps];
    let ok = true;
    
    const order = shuffle(pool, rand);
    
    for (const team of order) {
      const candidates = g
        .map((arr, idx) => ({idx, size: arr.length, cap: remaining[idx]}))
        .filter(x => x.cap > 0)
        .sort((a, b) => a.size - b.size || a.idx - b.idx)
        .map(x => x.idx);
      
      if (candidates.length === 0) {
        ok = false;
        break;
      }
      
      const pick = candidates[Math.floor(rand() * candidates.length)];
      g[pick].push(team);
      remaining[pick]--;
    }
    
    if (ok) return {groups: g, caps: capsBase, relaxed: false, attempt};
  }
  
  return {error: 'No se pudo asignar despu√©s de varios intentos'};
}

// ====================== RENDERIZADO DE RESULTADOS ======================
function renderGroups(target, result) {
  if (result.error) {
    target.innerHTML = `<div class="errorText">${result.error}</div>`;
    return;
  }
  
  const grid = document.createElement('div');
  grid.className = 'grid';
  
  result.groups.forEach((arr, gi) => {
    const card = document.createElement('div');
    card.className = 'zone';
    card.innerHTML = `<h4>Zona ${gi + 1}</h4>`;
    
    const ol = document.createElement('ol');
    arr.forEach(t => {
      const li = document.createElement('li');
      li.innerHTML = `<b>${escapeHtml(t.name)}</b>` +
        (t.province ? ` <span class="muted">‚Äî ${escapeHtml(t.province)}</span>` : '') +
        (t.head ? ' <span class="pill">Cabeza</span>' : '');
      ol.appendChild(li);
    });
    
    card.appendChild(ol);
    grid.appendChild(card);
  });
  
  target.innerHTML = '';
  target.appendChild(grid);
  
  const status = result.relaxed ? ' (con relajaci√≥n)' : '';
  const attempts = result.attempt != null ? ` (intentos: ${result.attempt + 1})` : '';
  document.getElementById('status').innerHTML = `Sorteo realizado${status}${attempts}`;
}

// ====================== VISTA PREVIA EN NUEVA PESTA√ëA CON PDF ======================
function openResultInNewTab(result, parameters = {}) {
  const w = window.open('', '_blank');
  if (!w) {
    toast('Permit√≠ pop-ups para ver el resultado en nueva pesta√±a');
    return;
  }
  
  const { discipline = '', category = '', gender = '' } = parameters;
  
  const zonesHTML = result.groups.map((arr, gi) => {
    const items = arr.map(t => 
      `<li><b>${escapeHtml(t.name)}</b>` +
      (t.province ? ` ‚Äî ${escapeHtml(t.province)}</span>` : '') +
      (t.head ? ' ‚òÖ' : '') +
      `</li>`
    ).join('');
    
    return `<div class="zone"><h4>Zona ${gi + 1}</h4><ol>${items}</ol></div>`;
  }).join('');

  const chipsHTML = [
    discipline ? `<span class="chip">Disciplina: ${escapeHtml(discipline)}</span>` : '',
    category ? `<span class="chip">Categor√≠a: ${escapeHtml(category)}</span>` : '',
    gender ? `<span class="chip">G√©nero: ${escapeHtml(gender)}</span>` : '',
    `<span class="chip">${result.groups.length} zonas</span>`,
    `<span class="chip">${new Date().toLocaleString()}</span>`
  ].filter(Boolean).join('');
  
  const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Resultado del Sorteo</title>
  <style>
    body { font-family: system-ui; background: #ffffff; color: #000000; margin: 0; padding: 20px; }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { margin-bottom: 16px; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin: 16px 0; }
    .chip { background: #ffffff; border: 1px solid #374151; padding: 6px 12px; border-radius: 20px; font-size: 14px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
    .zone { background: #ffffff; border: 2px solid #223046; border-radius: 6px; padding: 10px; }
    .zone h4 { margin: 4px 0 8px 0; }
    .zone ol { margin: 0; padding-left: 18px; }
    .muted { color: #94a3b8; }
    .pill { display: inline-flex; padding: 3px 8px; border: 1px solid #2b3b55; border-radius: 999px; background: #0b1220; font-size: 12px; }
    .btn { background: #ffffff; color: #000000; border: 1px solid #223046; padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 10px; }
    .btn:hover { border-color: #3b82f6; }
    .btn.primary { background: linear-gradient(135deg, #22c55e, #16a34a); border: 0; color: #ffffff; }
    .controls { margin: 20px 0; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"><\/script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"><\/script>
</head>
<body>
  <div class="container">
    <h1>üé≤ Resultado del Sorteo</h1>
    <div class="chips">${chipsHTML}</div>
    <div class="grid">${zonesHTML}</div>
    <div class="controls">
      <button class="btn primary" onclick="exportPDF()">üñ®Ô∏è Exportar PDF</button>
    </div>
  </div>
  <script>
    function exportPDF() {
      try {
        if (!window.jspdf || !window.html2canvas) {
          alert('Librer√≠as de PDF no cargadas. Intenta recargar la p√°gina.');
          return;
        }

        const sheet = document.createElement('div');
        sheet.style.width = '794px';
        sheet.style.height = '1123px';
        sheet.style.background = '#ffffff';
        sheet.style.color = '#0f172a';
        sheet.style.position = 'fixed';
        sheet.style.left = '-9999px';
        sheet.style.top = '0';
        sheet.style.display = 'flex';
        sheet.style.flexDirection = 'column';
        sheet.style.fontFamily = 'system-ui, sans-serif';
        sheet.style.padding = '20px';

        // Header
        const header = document.createElement('div');
        header.innerHTML = '<h1 style="margin: 0 0 16px 0; font-size: 24px;">Resultado del Sorteo</h1>';
        sheet.appendChild(header);

        // Chips
        const chips = document.createElement('div');
        chips.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;';
        chips.innerHTML = '${chipsHTML.replace(/'/g, "\\'")}';
        sheet.appendChild(chips);

        // Zones grid
        const grid = document.createElement('div');
        grid.style.cssText = 'display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; flex: 0;';
        grid.innerHTML = '${zonesHTML.replace(/'/g, "\\'")}';
        sheet.appendChild(grid);

        document.body.appendChild(sheet);

        html2canvas(sheet, { 
          backgroundColor: '#ffffff',
          scale: 2,
          useCORS: true 
        }).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          document.body.removeChild(sheet);

          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'pt',
            format: 'a4'
          });

          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          
          pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
          pdf.save('sorteo_${new Date().toISOString().slice(0,10)}.pdf');
        });

      } catch (error) {
        console.error('Error generando PDF:', error);
        alert('Error al generar PDF: ' + error.message);
      }
    }
  <\/script>
</body>
</html>`;
  
  w.document.open();
  w.document.write(html);
  w.document.close();
}

// ====================== FUNCIONES DE PDF PARA SORTEO SIMPLE ======================
function openSimpleResultInNewTab(result, parameters = {}) {
  const w = window.open('', '_blank');
  if (!w) {
    toast('Permit√≠ pop-ups para ver el resultado en nueva pesta√±a');
    return;
  }
  
  const { discipline = '', category = '', gender = '' } = parameters;
  const { list } = result;
  
  const listHTML = list.map((name, index) => 
    `<div style="margin: 8px 0; padding: 6px 0; border-bottom: 1px solid #eee;">${index + 1}. <b>${escapeHtml(name)}</b></div>`
  ).join('');
  
  const chipsHTML = [
    discipline ? `<span class="chip">Disciplina: ${escapeHtml(discipline)}</span>` : '',
    category ? `<span class="chip">Categor√≠a: ${escapeHtml(category)}</span>` : '',
    gender ? `<span class="chip">G√©nero: ${escapeHtml(gender)}</span>` : '',
    `<span class="chip">${list.length} equipos</span>`,
    `<span class="chip">${new Date().toLocaleString()}</span>`
  ].filter(Boolean).join('');
  
  const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Resultado del Sorteo Simple</title>
  <style>
    body { font-family: system-ui; background: #ffffff; color: #000000; margin: 0; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { margin-bottom: 16px; color: #0f172a; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin: 16px 0; }
    .chip { background: #f1f5f9; border: 1px solid #cbd5e1; padding: 6px 12px; border-radius: 20px; font-size: 14px; color: #475569; }
    .btn { background: #ffffff; color: #000000; border: 1px solid #223046; padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 10px; }
    .btn:hover { border-color: #3b82f6; }
    .btn.primary { background: linear-gradient(135deg, #22c55e, #16a34a); border: 0; color: #ffffff; }
    .result { margin: 20px 0; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"><\/script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"><\/script>
</head>
<body>
  <div class="container">
    <h1>üé≤ Resultado del Sorteo Simple</h1>
    <div class="chips">${chipsHTML}</div>
    <div class="result">${listHTML}</div>
    <div class="controls">
      <button class="btn primary" onclick="exportPDF()">üñ®Ô∏è Exportar PDF</button>
    </div>
  </div>
  <script>
    function exportPDF() {
      try {
        if (!window.jspdf || !window.html2canvas) {
          alert('Librer√≠as de PDF no cargadas. Intenta recargar la p√°gina.');
          return;
        }

        const sheet = document.createElement('div');
        sheet.style.width = '794px';
        sheet.style.height = '1123px';
        sheet.style.background = '#ffffff';
        sheet.style.color = '#0f172a';
        sheet.style.position = 'fixed';
        sheet.style.left = '-9999px';
        sheet.style.top = '0';
        sheet.style.display = 'flex';
        sheet.style.flexDirection = 'column';
        sheet.style.fontFamily = 'system-ui, sans-serif';
        sheet.style.padding = '20px';

        // Header
        const header = document.createElement('div');
        header.innerHTML = '<h1 style="margin: 0 0 16px 0; font-size: 24px;">Resultado del Sorteo Simple</h1>';
        sheet.appendChild(header);

        // Chips
        const chips = document.createElement('div');
        chips.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;';
        chips.innerHTML = '${chipsHTML.replace(/'/g, "\\'")}';
        sheet.appendChild(chips);

        // Result list
        const resultDiv = document.createElement('div');
        resultDiv.style.cssText = 'flex: 1;';
        resultDiv.innerHTML = '${listHTML.replace(/'/g, "\\'")}';
        sheet.appendChild(resultDiv);

        document.body.appendChild(sheet);

        html2canvas(sheet, { 
          backgroundColor: '#ffffff',
          scale: 2,
          useCORS: true 
        }).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          document.body.removeChild(sheet);

          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'pt',
            format: 'a4'
          });

          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          
          pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
          pdf.save('sorteo_simple_${new Date().toISOString().slice(0,10)}.pdf');
        });

      } catch (error) {
        console.error('Error generando PDF:', error);
        alert('Error al generar PDF: ' + error.message);
      }
    }
  <\/script>
</body>
</html>`;
  
  w.document.open();
  w.document.write(html);
  w.document.close();
}

// ====================== EXPORTACI√ìN ======================
function exportGroupsCSV(groups) {
  let csv = 'Zona,Posicion,Equipo,Provincia,Cabeza\n';
  groups.forEach((arr, gi) => {
    arr.forEach((t, i) => {
      csv += `${gi + 1},${i + 1},"${t.name.replace(/"/g, '""')}",` +
             `"${(t.province || '').replace(/"/g, '""')}",` +
             `${t.head ? 'si' : 'no'}\n`;
    });
  });
  downloadText(csv, 'sorteo_zonas.csv');
}

function exportSimpleCSV(list) {
  let csv = 'Posicion,Equipo\n';
  list.forEach((name, i) => {
    csv += `${i + 1},"${name.replace(/"/g, '""')}"\n`;
  });
  downloadText(csv, 'sorteo_simple.csv');
}

// ====================== GESTI√ìN DE ESTADO ======================
function getFormat() {
  const selected = document.querySelector('input[name="format"]:checked');
  return selected ? selected.value : 'custom';
}

function currentZones() {
  const fmt = getFormat();
  if (fmt === '8x3') return 8;
  if (fmt === '4x6') return 4;
  return parseInt(document.getElementById('zones').value) || 1;
}

function updateCapInfo() {
  const teams = getActiveTeamsLive().length;
  const z = currentZones();
  const fmt = getFormat();
  
  let msg = `Equipos: ${teams} ¬∑ Zonas: ${z}`;
  
  if (fmt === '4x6') {
    if (teams <= 24) {
      const caps = capacitiesFourBySix(teams);
      msg += ` ‚Äî Distribuci√≥n: ${caps.join('-')}`;
    } else {
      msg += ' ‚Äî Distribuci√≥n pareja';
    }
  } else if (fmt === '8x3') {
    if (teams <= 24) {
      const caps = capacitiesEightByThree(teams);
      msg += ` ‚Äî Distribuci√≥n: ${caps.join('-')}`;
      if (teams < 16) msg += ' ‚Äî <span class="warnText">Considere cambiar de sistema</span>';
    } else {
      msg += ' ‚Äî Distribuci√≥n pareja';
    }
  } else {
    const avg = (teams / z).toFixed(2);
    msg += ` ‚Äî Promedio: ${avg} por zona`;
  }
  
  document.getElementById('capInfo').innerHTML = msg;
}

// ====================== INICIALIZACI√ìN MEJORADA ======================
document.addEventListener('DOMContentLoaded', function() {
  console.log('Sorteador v3.3 cargado');
  
  // Cargar sorteos guardados al iniciar
  console.log('Sorteos guardados:', getSavedDraws());
  
  // Tabs
  document.querySelectorAll('.tab').forEach(btn => {
    btn.addEventListener('click', () => {
      const tabName = btn.dataset.tab;
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tabcontent').forEach(c => c.classList.add('hidden'));
      btn.classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.remove('hidden');
      
      // Si es la pesta√±a de guardados, renderizar
      if (tabName === 'saved') {
        renderSavedDraws();
      }
    });
  });
  
  // Bot√≥n para eliminar todos los sorteos
  document.getElementById('btnClearAllSaved').addEventListener('click', clearAllSavedDraws);
  
  // Bot√≥n para exportar todos los sorteos
  document.getElementById('btnExportAllSaved').addEventListener('click', exportAllSavedDraws);
  
  // Importar sorteos
  document.getElementById('importSaved').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    importSavedDraws(file);
    e.target.value = ''; // Resetear input
  });
  
  // Limpiar resultados cuando cambian par√°metros importantes
  document.getElementById('disciplineSelect').addEventListener('change', clearResults);
  document.getElementById('categorySelect').addEventListener('change', clearResults);
  document.getElementById('genderSelect').addEventListener('change', clearResults);
  document.getElementById('disciplineSelectSimple').addEventListener('change', clearResults);
  document.getElementById('disciplineSelectBracket').addEventListener('change', clearResults);
  
  // Formato de zonas
  document.querySelectorAll('input[name="format"]').forEach(radio => {
    radio.addEventListener('change', () => {
      const zonesInput = document.getElementById('zones');
      if (radio.value === '8x3') {
        zonesInput.value = '8';
        zonesInput.disabled = true;
      } else if (radio.value === '4x6') {
        zonesInput.value = '4';
        zonesInput.disabled = true;
      } else {
        zonesInput.disabled = false;
      }
      updateCapInfo();
      clearResults(); // Limpiar resultados cuando cambia el formato
    });
  });
  
  // Lista de checks
  document.getElementById('btnBuildList').addEventListener('click', buildListsFromTextarea);
  document.getElementById('toggleShowInactive').addEventListener('change', renderLists);
  document.getElementById('btnMoveToInactive').addEventListener('click', moveSelectedToInactive);
  document.getElementById('btnRestoreSelected').addEventListener('click', restoreSelectedFromInactive);
  document.getElementById('btnSelectAllActive').addEventListener('click', () => selectAll('.chkActive'));
  document.getElementById('btnSelectAllInactive').addEventListener('click', () => selectAll('.chkInactive'));
  
  // Importaci√≥n de equipos CSV
  document.getElementById('csvFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function() {
      try {
        const result = importTeamsCSV(reader.result);
        
        if (result.teams.length === 0) {
          toast('CSV vac√≠o o no se detectaron equipos');
          return;
        }
        
        // Actualizar textarea
        document.getElementById('teamsInput').value = result.teams
          .map(t => `${t.name}${t.province ? `; ${t.province}` : ''}${t.head ? '; *' : ''}`)
          .join('\n');
        
        buildListsFromTextarea();
        
        // Mostrar info
        const info = `CSV cargado: ${result.teams.length} equipos ¬∑ Delimitador: ${result.delimiter === '\t' ? 'TAB' : result.delimiter}${result.hasHeaders ? ' ¬∑ Con cabecera' : ''}`;
        document.getElementById('csvInfo').innerHTML = info;
        toast('CSV de equipos cargado correctamente');
        
      } catch (error) {
        console.error(error);
        alert('Error: ' + error.message);
      }
    };
    reader.readAsText(file, 'UTF-8');
  });

  // Importaci√≥n de disciplinas CSV
  document.getElementById('csvDisciplines').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function() {
      try {
        const result = importDisciplinesCSV(reader.result);
        disciplines = result.items;
        refreshDisciplineSelects();
        
        const info = `CSV cargado: ${disciplines.length} disciplinas ¬∑ Delimitador: ${result.delimiter === '\t' ? 'TAB' : result.delimiter}${result.hasHeaders ? ' ¬∑ Con cabecera' : ''}`;
        document.getElementById('discCSVInfo').innerHTML = info;
        toast('CSV de disciplinas cargado correctamente');
        
      } catch (error) {
        console.error(error);
        alert('Error: ' + error.message);
      }
    };
    reader.readAsText(file, 'UTF-8');
  });

  // Importaci√≥n de categor√≠as CSV
  document.getElementById('csvCategories').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function() {
      try {
        const result = importCategoriesCSV(reader.result);
        categories = result.items;
        refreshCategorySelects();
        
        const info = `CSV cargado: ${categories.length} categor√≠as ¬∑ Delimitador: ${result.delimiter === '\t' ? 'TAB' : result.delimiter}${result.hasHeaders ? ' ¬∑ Con cabecera' : ''}`;
        document.getElementById('catCSVInfo').innerHTML = info;
        toast('CSV de categor√≠as cargado correctamente');
        
      } catch (error) {
        console.error(error);
        alert('Error: ' + error.message);
      }
    };
    reader.readAsText(file, 'UTF-8');
  });

  // Demo disciplinas
  document.getElementById('btnDiscDemo').addEventListener('click', () => {
    disciplines = [
      {name: 'F√∫tbol', seed: 'futbol'},
      {name: 'B√°squet', seed: 'basquet'},
      {name: 'V√≥ley', seed: 'voley'},
      {name: 'Hockey', seed: 'hockey'}
    ];
    refreshDisciplineSelects();
    document.getElementById('discCSVInfo').innerHTML = 'Demo: 4 disciplinas cargadas';
    toast('Disciplinas demo cargadas');
  });

  // Demo categor√≠as
  document.getElementById('btnCatDemo').addEventListener('click', () => {
    categories = [
      {name: 'Sub-15', seed: 'sub15'},
      {name: 'Sub-17', seed: 'sub17'},
      {name: 'Senior', seed: 'senior'},
      {name: 'Libre', seed: 'libre'}
    ];
    refreshCategorySelects();
    document.getElementById('catCSVInfo').innerHTML = 'Demo: 4 categor√≠as cargadas';
    toast('Categor√≠as demo cargadas');
  });
  
  // Ejemplo y limpiar
  document.getElementById('btnExample').addEventListener('click', () => {
    const example = `River Plate; CABA; *
Boca Juniors; CABA; *
Newell's; Santa Fe
Rosario Central; Santa Fe
San Lorenzo; CABA
Racing; Buenos Aires
Independiente; Buenos Aires
Estudiantes; Buenos Aires
Talleres; C√≥rdoba
Belgrano; C√≥rdoba
Godoy Cruz; Mendoza
Atl. Tucum√°n; Tucum√°n`;
    document.getElementById('teamsInput').value = example;
    updateCapInfo();
    clearResults(); // Limpiar resultados al cargar ejemplo
  });
  
  document.getElementById('btnClear').addEventListener('click', () => {
    document.getElementById('teamsInput').value = '';
    clearResults();
    activeTeams = [];
    inactiveTeams = [];
    document.getElementById('checkLists').classList.add('hidden');
    updateCapInfo();
  });
  
  // Sorteo de zonas - CORREGIDO
  document.getElementById('btnDrawGroups').addEventListener('click', () => {
    const teams = getActiveTeamsLive();
    if (teams.length === 0) {
      document.getElementById('status').innerHTML = '<span class="errorText">No hay equipos activos</span>';
      return;
    }
    
    const z = currentZones();
    const seed = document.getElementById('disciplineSelect').value || 'sorteo';
    const headsAsFirst = document.getElementById('headsAsFirst').checked;
    const format = getFormat();
    
    // Limpiar resultado anterior antes de generar nuevo
    document.getElementById('resultGroups').innerHTML = '';
    document.getElementById('status').innerHTML = 'Generando sorteo...';
    
    const result = drawGroups(teams, z, headsAsFirst, seed, format);
    
    // Actualizar el resultado actual
    currentResult = {
      result: result,
      parameters: {
        discipline: document.getElementById('disciplineSelect').value,
        category: document.getElementById('categorySelect').value,
        gender: document.getElementById('genderSelect').value
      }
    };
    
    renderGroups(document.getElementById('resultGroups'), result);
    
    if (!result.error) {
      // Abrir en nueva pesta√±a
      const parameters = {
        discipline: document.getElementById('disciplineSelect').options[document.getElementById('disciplineSelect').selectedIndex]?.text || '',
        category: document.getElementById('categorySelect').value || '',
        gender: document.getElementById('genderSelect').value || ''
      };
      openResultInNewTab(result, parameters);
      
      // Guardar en el historial
      saveDraw('grupos', parameters, result);
      
      if (format === '8x3' && teams.length < 16) {
        document.getElementById('status').innerHTML += ' ¬∑ <span class="warnText">Considere cambiar de sistema</span>';
      }
    }
  });
  
  // Exportar y compartir
  document.getElementById('btnExportCSV').addEventListener('click', () => {
    const teams = getActiveTeamsLive();
    const z = currentZones();
    const seed = document.getElementById('disciplineSelect').value || 'sorteo';
    const headsAsFirst = document.getElementById('headsAsFirst').checked;
    const format = getFormat();
    
    const result = drawGroups(teams, z, headsAsFirst, seed, format);
    if (result.error) {
      toast('Gener√° el sorteo primero');
      return;
    }
    
    exportGroupsCSV(result.groups);
  });
  
  document.getElementById('btnCopy').addEventListener('click', () => {
    const zones = document.querySelectorAll('#resultGroups .zone');
    if (zones.length === 0) {
      toast('No hay resultado para copiar');
      return;
    }
    
    let text = '';
    zones.forEach((zone, i) => {
      text += `Zona ${i + 1}\n`;
      zone.querySelectorAll('li').forEach((li, j) => {
        text += `${j + 1}. ${li.textContent}\n`;
      });
      text += '\n';
    });
    
    copyText(text);
  });

  // Sorteo simple - Usar lista del tab Grupos
  document.getElementById('btnUseFromGroups').addEventListener('click', () => {
    const teams = getActiveTeamsLive();
    const teamNames = teams.map(t => t.name);
    document.getElementById('simpleInput').value = teamNames.join('\n');
    toast('Lista copiada al tab Sorteo simple');
  });

  // Sorteo simple - Limpiar
  document.getElementById('btnClearSimple').addEventListener('click', () => {
    document.getElementById('simpleInput').value = '';
    document.getElementById('resultSimple').innerHTML = '';
    document.getElementById('statusSimple').innerHTML = '';
  });

  // Sorteo simple - Sortear CORREGIDO
  document.getElementById('btnDrawSimple').addEventListener('click', () => {
    const seed = document.getElementById('disciplineSelectSimple').value || 'sorteo';
    const names = document.getElementById('simpleInput').value.split('\n')
      .map(name => name.trim())
      .filter(name => name.length > 0);
    
    if (names.length === 0) {
      document.getElementById('statusSimple').innerHTML = '<span class="errorText">No hay equipos</span>';
      return;
    }
    
    // Limpiar resultado anterior
    document.getElementById('resultSimple').innerHTML = '';
    document.getElementById('statusSimple').innerHTML = 'Generando sorteo...';
    
    const rand = rngFromSeed(seed);
    const shuffled = shuffle(names, rand);
    
    const resultHTML = shuffled.map((name, index) => 
      `<div>${index + 1}. <b>${escapeHtml(name)}</b></div>`
    ).join('');
    
    document.getElementById('resultSimple').innerHTML = resultHTML;
    document.getElementById('statusSimple').innerHTML = 'Sorteo realizado';
    
    // Guardar en el historial
    const parameters = {
      discipline: document.getElementById('disciplineSelectSimple').options[document.getElementById('disciplineSelectSimple').selectedIndex]?.text || '',
      category: '',
      gender: ''
    };
    saveDraw('simple', parameters, { list: shuffled });
  });

  // Sorteo simple - Exportar CSV
  document.getElementById('btnExportSimple').addEventListener('click', () => {
    const names = document.getElementById('resultSimple').textContent
      .split('\n')
      .map(line => line.replace(/^\d+\.\s*/, '').trim())
      .filter(name => name.length > 0);
    
    if (names.length === 0) {
      toast('No hay resultado para exportar');
      return;
    }
    
    exportSimpleCSV(names);
  });

  // Sorteo simple - Copiar
  document.getElementById('btnCopySimple').addEventListener('click', () => {
    const text = document.getElementById('resultSimple').textContent;
    if (!text.trim()) {
      toast('No hay resultado para copiar');
      return;
    }
    
    copyText(text);
  });
  
  // Sorteo simple - Exportar PDF
  document.getElementById('btnExportPDFSimple').addEventListener('click', () => {
    const names = document.getElementById('resultSimple').textContent
      .split('\n')
      .map(line => line.replace(/^\d+\.\s*/, '').trim())
      .filter(name => name.length > 0);
    
    if (names.length === 0) {
      toast('No hay resultado para exportar');
      return;
    }
    
    const parameters = {
      discipline: document.getElementById('disciplineSelectSimple').options[document.getElementById('disciplineSelectSimple').selectedIndex]?.text || '',
      category: '',
      gender: ''
    };
    
    openSimpleResultInNewTab({ list: names }, parameters);
  });
  
  // Inicializaci√≥n
  updateCapInfo();
});
</script>
</body>
</html>
