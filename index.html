<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sorteador Deportivo</title>
  <style>
    :root{--bg:#0f172a;--panel:#111827;--card:#1f2937;--muted:#94a3b8;--text:#e5e7eb;--accent:#22c55e;--accent2:#38bdf8;--danger:#ef4444;--warn:#f59e0b}
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    a{color:var(--accent2)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
    h1{font-size:clamp(22px,3vw,30px);margin:0}
    .badge{font-size:12px;background:#0b2;opacity:.9;padding:4px 8px;border-radius:999px}
    .panel{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #243042;border-radius:14px;padding:14px}
    .card h3{margin:0 0 8px 0;font-size:16px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=number],textarea,select{width:100%;background:#0b1220;color:var(--text);border:1px solid #223046;border-radius:10px;padding:10px;font-size:14px}
    textarea{min-height:200px;resize:vertical}
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .btn{background:#0b1220;color:var(--text);border:1px solid #223046;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn:hover{border-color:#3b82f6}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#16a34a);border:0;color:#052e16}
    .btn.ghost{background:transparent;border-color:#2b3b55}
    .btn.warn{background:linear-gradient(135deg,var(--warn),#d97706);border:0;color:#3b1d00}
    .btn.danger{background:linear-gradient(135deg,var(--danger),#dc2626);border:0;color:#450a0a}
    .tiny{font-size:12px;color:var(--muted)}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:10px;border:1px solid #223046;background:#0b1220;cursor:pointer;color:#e5e7eb}
    .tab.active{background:#0a3622;border-color:#1b5e3b;color:#22c55e}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
    .zone{background:#0b1220;border:1px solid #223046;border-radius:14px;padding:10px}
    .zone h4{margin:4px 0 8px 0}
    .zone ol{margin:0;padding-left:18px}
    .muted{color:var(--muted)}
    .warnText{color:var(--warn)}
    .errorText{color:var(--danger)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border:1px solid #2b3b55;border-radius:999px;background:#0b1220}
    .hidden{display:none}
    .history{display:grid;gap:8px}
    .history .item{background:#0b1220;border:1px dashed #2b3b55;padding:8px;border-radius:10px;font-size:13px}
    .listWrap{display:grid;grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:900px){.listWrap{grid-template-columns:1fr}}
    .listBox{background:#0b1220;border:1px dashed #2b3b55;border-radius:12px;padding:10px;min-height:120px}
    .listBox h4{margin:2px 0 8px 0;font-size:14px}
    .itemRow{display:flex;align-items:center;gap:8px;padding:4px 6px;border-bottom:1px dashed #1f2a3b}
    .itemRow:last-child{border-bottom:none}
    .tag{font-size:11px;color:#cbd5e1;border:1px solid #334155;border-radius:999px;padding:1px 6px}
    .savedDrawItem{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#0b1220;border:1px solid #223046;border-radius:10px;margin-bottom:8px}
    .savedDrawInfo{flex:1}
    .savedDrawActions{display:flex;gap:6px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>üé≤ Sorteador Deportivo</h1>
        <div class="tiny">Funciona 100% en tu navegador (sin backend).</div>
      </div>
      <span class="badge">v3.0</span>
    </header>

    <div class="panel">
      <div class="tabs">
        <button class="tab active" data-tab="grupos" type="button">Zonas / Grupos</button>
        <button class="tab" data-tab="simple" type="button">Sorteo simple</button>
        <button class="tab" data-tab="bracket" type="button">Eliminaci√≥n directa (beta)</button>
        <button class="tab" data-tab="saved" type="button">üìä Sorteos realizados</button>
      </div>

      <div id="tab-grupos" class="tabcontent">
        <!-- Contenido existente de grupos -->
        <div class="row">
          <div class="card">
            <h3>Equipos</h3>
            <label>Peg√° la lista (una l√≠nea por equipo). Opcional: <span class="pill">; Provincia</span> y <span class="pill">; *</span> para cabeza.</label>
            <textarea id="teamsInput" placeholder="Ejemplos:
River Plate; CABA; *
Boca Juniors; CABA
Newell's; Santa Fe
..."></textarea>
            <div class="controls" style="margin-top:8px">
              <label for="csvFile" class="btn ghost">üìÑ Importar CSV de equipos</label>
              <input id="csvFile" type="file" accept=".csv,text/csv" class="hidden" />
              <button class="btn ghost" id="btnExample" type="button">Cargar ejemplo</button>
              <button class="btn ghost" id="btnClear" type="button">Limpiar</button>
              <button class="btn" id="btnBuildList" type="button">üóÇÔ∏è Mostrar lista con checks</button>
            </div>
            <div class="tiny">CSV de equipos: <b>Equipo, Provincia, Cabeza</b> ("s√≠" para cabeza). Acepta <b>,</b>, <b>;</b> o <b>TAB</b>, con o sin cabecera.</div>
            <div id="csvInfo" class="tiny" style="margin-top:6px"></div>

            <div id="checkLists" class="listWrap hidden" style="margin-top:10px">
              <div class="listBox">
                <h4>Activos (participan) <span class="tag" id="countActive">0</span></h4>
                <div class="controls" style="margin-bottom:6px">
                  <button class="btn tiny" id="btnSelectAllActive" type="button">Seleccionar todo</button>
                  <button class="btn warn tiny" id="btnMoveToInactive" type="button">Descartar seleccionados ‚ûú</button>
                </div>
                <div id="activeList"></div>
              </div>
              <div class="listBox">
                <h4>Descartados <span class="tag" id="countInactive">0</span></h4>
                <div class="controls" style="margin-bottom:6px">
                  <label class="pill"><input type="checkbox" id="toggleShowInactive"> Mostrar descartados</label>
                  <button class="btn tiny" id="btnSelectAllInactive" type="button">Seleccionar todo</button>
                  <button class="btn primary tiny" id="btnRestoreSelected" type="button">‚¨Ö Restaurar seleccionados</button>
                </div>
                <div id="inactiveList" class="hidden"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Par√°metros</h3>
            <div class="controls" id="formatRow">
              <label class="pill"><input type="radio" name="format" value="8x3" checked> 8 zonas de 3</label>
              <label class="pill"><input type="radio" name="format" value="4x6"> 4 zonas de 6</label>
              <label class="pill"><input type="radio" name="format" value="custom"> Personalizado</label>
            </div>
            <div class="controls">
              <div style="min-width:160px;flex:1">
                <label>N¬∫ de zonas / grupos</label>
                <input type="number" id="zones" min="1" value="8" />
              </div>
              <div style="min-width:220px;flex:1">
                <label>Disciplina</label>
                <select id="disciplineSelect">
                  <option value="">‚Äî Seleccionar disciplina ‚Äî</option>
                </select>
              </div>
            </div>
            <div class="controls">
              <div style="min-width:220px;flex:1">
                <label>Categor√≠a</label>
                <select id="categorySelect">
                  <option value="">‚Äî Seleccionar categor√≠a ‚Äî</option>
                </select>
              </div>
              <div style="min-width:220px;flex:1">
                <label>G√©nero</label>
                <select id="genderSelect">
                  <option value="">‚Äî Seleccionar g√©nero ‚Äî</option>
                  <option value="Masculino">Masculino</option>
                  <option value="Femenino">Femenino</option>
                  <option value="Mixto">Mixto</option>
                  <option value="No Aplica">No Aplica</option>
                </select>
              </div>
            </div>
            <div class="controls">
              <label for="csvDisciplines" class="btn ghost">üìÑ Importar CSV de disciplinas</label>
              <input id="csvDisciplines" type="file" accept=".csv,text/csv" class="hidden" />
              <button class="btn ghost" id="btnDiscDemo" type="button">Cargar disciplinas demo</button>
              <label for="csvCategories" class="btn ghost">üìÑ Importar CSV de categor√≠as</label>
              <input id="csvCategories" type="file" accept=".csv,text/csv" class="hidden" />
              <button class="btn ghost" id="btnCatDemo" type="button">Cargar categor√≠as demo</button>
            </div>
            <div id="discCSVInfo" class="tiny" style="margin-top:4px"></div>
            <div id="catCSVInfo" class="tiny" style="margin-top:4px"></div>

            <label><input type="checkbox" id="headsAsFirst" checked> Cabezas de serie primero</label>
            <div id="capInfo" class="tiny" style="margin-top:6px"></div>

            <div class="controls" style="margin-top:10px">
              <button class="btn primary" id="btnDrawGroups" type="button">üéØ SORTEAR ZONAS</button>
              <button class="btn" id="btnExportCSV" type="button">‚¨áÔ∏è Exportar CSV</button>
              <button class="btn" id="btnCopy" type="button">üìã Copiar</button>
              <button class="btn" id="btnShare" type="button">üîó Compartir</button>
            </div>
            <div id="status" class="tiny" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Resultado</h3>
          <div id="resultGroups" class="grid"></div>
        </div>
      </div>

      <div id="tab-simple" class="tabcontent hidden">
        <div class="row">
          <div class="card">
            <h3>Equipos</h3>
            <label>Usa la lista del tab Grupos (o peg√° otra):</label>
            <textarea id="simpleInput" placeholder="Uno por l√≠nea..."></textarea>
            <div class="controls" style="margin-top:8px">
              <button class="btn ghost" id="btnUseFromGroups" type="button">Usar lista del tab Grupos</button>
              <button class="btn ghost" id="btnClearSimple" type="button">Limpiar</button>
            </div>
          </div>
          <div class="card">
            <h3>Par√°metros</h3>
            <div class="controls">
              <div style="min-width:220px;flex:1">
                <label>Disciplina</label>
                <select id="disciplineSelectSimple">
                  <option value="">‚Äî Seleccionar disciplina ‚Äî</option>
                </select>
              </div>
            </div>
            <div class="controls" style="margin-top:10px">
              <button class="btn primary" id="btnDrawSimple" type="button">üé≤ SORTEAR ORDEN</button>
              <button class="btn" id="btnExportSimple" type="button">‚¨áÔ∏è Exportar CSV</button>
              <button class="btn" id="btnCopySimple" type="button">üìã Copiar</button>
              <button class="btn" id="btnExportPDFSimple" type="button">üñ®Ô∏è Exportar PDF</button>
            </div>
            <div id="statusSimple" class="tiny" style="margin-top:8px"></div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>Resultado</h3>
          <div id="resultSimple"></div>
        </div>
      </div>

      <div id="tab-bracket" class="tabcontent hidden">
        <div class="row">
          <div class="card">
            <h3>Equipos</h3>
            <label>Usa la lista del tab Grupos (o peg√° otra):</label>
            <textarea id="bracketInput" placeholder="Uno por l√≠nea..."></textarea>
            <div class="controls" style="margin-top:8px">
              <button class="btn ghost" id="btnUseFromGroups2" type="button">Usar lista del tab Grupos</button>
              <button class="btn ghost" id="btnClearBracket" type="button">Limpiar</button>
            </div>
          </div>
          <div class="card">
            <h3>Par√°metros</h3>
            <div class="controls">
              <div style="min-width:220px;flex:1">
                <label>Disciplina</label>
                <select id="disciplineSelectBracket">
                  <option value="">‚Äî Seleccionar disciplina ‚Äî</option>
                </select>
              </div>
            </div>
            <div class="controls" style="margin-top:10px">
              <button class="btn primary" id="btnDrawBracket" type="button">ü•ä Generar llaves</button>
              <button class="btn" id="btnExportBracket" type="button">‚¨áÔ∏è Exportar CSV</button>
              <div class="tiny">Si el n¬∫ de equipos no es potencia de 2, se completa con BYE.</div>
            </div>
            <div id="statusBracket" class="tiny" style="margin-top:8px"></div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>Resultado</h3>
          <div id="resultBracket" class="grid"></div>
        </div>
      </div>

      <div id="tab-saved" class="tabcontent hidden">
        <div class="card">
          <h3>üìä Sorteos Realizados</h3>
          <div class="tiny" style="margin-bottom:12px">Todos los sorteos se guardan autom√°ticamente en tu navegador.</div>
          <div id="savedDrawsList"></div>
        </div>
      </div>
    </div>

    <div class="tiny" style="margin-top:12px">Hecho con ‚ù§Ô∏è. Todo ocurre del lado del cliente (no se sube nada). Pod√©s guardar y compartir con "üîó Compartir".</div>
  </div>

<script>
'use strict';

// ====================== CONFIGURACI√ìN INICIAL ======================
let activeTeams = [];
let inactiveTeams = [];
let disciplines = [];
let categories = [];

// ====================== SISTEMA DE ALMACENAMIENTO ======================
const STORAGE_KEY = 'savedDraws';

function saveDraw(type, parameters, result) {
  const savedDraws = getSavedDraws();
  const draw = {
    id: Date.now(),
    type,
    parameters,
    result,
    date: new Date().toLocaleString()
  };
  savedDraws.unshift(draw);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(savedDraws));
  return draw;
}

function getSavedDraws() {
  return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
}

function deleteDraw(id) {
  const savedDraws = getSavedDraws();
  const filtered = savedDraws.filter(draw => draw.id !== id);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(filtered));
  renderSavedDraws();
}

function renderSavedDraws() {
  const container = document.getElementById('savedDrawsList');
  const savedDraws = getSavedDraws();
  
  if (savedDraws.length === 0) {
    container.innerHTML = '<div class="muted">No hay sorteos guardados a√∫n.</div>';
    return;
  }
  
  container.innerHTML = savedDraws.map(draw => `
    <div class="savedDrawItem">
      <div class="savedDrawInfo">
        <div><b>${draw.type === 'grupos' ? 'üèÜ Sorteo de Zonas' : 'üé≤ Sorteo Simple'}</b></div>
        <div class="tiny">
          ${draw.parameters.discipline ? draw.parameters.discipline + ' ‚Ä¢ ' : ''}
          ${draw.parameters.category ? draw.parameters.category + ' ‚Ä¢ ' : ''}
          ${draw.parameters.gender ? draw.parameters.gender + ' ‚Ä¢ ' : ''}
          ${draw.date}
        </div>
        <div class="tiny">
          ${draw.type === 'grupos' ? 
            `${draw.result.groups.length} zonas ‚Ä¢ ${draw.result.groups.flat().length} equipos` : 
            `${draw.result.list.length} equipos`
          }
        </div>
      </div>
      <div class="savedDrawActions">
        <button class="btn tiny" onclick="openSavedDraw(${draw.id})">Abrir</button>
        <button class="btn danger tiny" onclick="deleteDraw(${draw.id})">Eliminar</button>
      </div>
    </div>
  `).join('');
}

function openSavedDraw(id) {
  const savedDraws = getSavedDraws();
  const draw = savedDraws.find(d => d.id === id);
  if (!draw) {
    toast('Sorteo no encontrado');
    return;
  }
  
  if (draw.type === 'grupos') {
    openResultInNewTab(draw.result, draw.parameters);
  } else if (draw.type === 'simple') {
    openSimpleResultInNewTab(draw.result, draw.parameters);
  }
}

// ====================== FUNCIONES DE PDF PARA SORTEO SIMPLE ======================
function openSimpleResultInNewTab(result, parameters = {}) {
  const w = window.open('', '_blank');
  if (!w) {
    toast('Permit√≠ pop-ups para ver el resultado en nueva pesta√±a');
    return;
  }
  
  const { discipline = '', category = '', gender = '' } = parameters;
  const { list } = result;
  
  const listHTML = list.map((name, index) => 
    `<div style="margin: 8px 0; padding: 6px 0; border-bottom: 1px solid #eee;">${index + 1}. <b>${escapeHtml(name)}</b></div>`
  ).join('');
  
  const chipsHTML = [
    discipline ? `<span class="chip">Disciplina: ${escapeHtml(discipline)}</span>` : '',
    category ? `<span class="chip">Categor√≠a: ${escapeHtml(category)}</span>` : '',
    gender ? `<span class="chip">G√©nero: ${escapeHtml(gender)}</span>` : '',
    `<span class="chip">${list.length} equipos</span>`,
    `<span class="chip">${new Date().toLocaleString()}</span>`
  ].filter(Boolean).join('');
  
  const html = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Resultado del Sorteo Simple</title>
  <style>
    body { font-family: system-ui; background: #ffffff; color: #000000; margin: 0; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { margin-bottom: 16px; color: #0f172a; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin: 16px 0; }
    .chip { background: #f1f5f9; border: 1px solid #cbd5e1; padding: 6px 12px; border-radius: 20px; font-size: 14px; color: #475569; }
    .btn { background: #ffffff; color: #000000; border: 1px solid #223046; padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; margin-top: 10px; }
    .btn:hover { border-color: #3b82f6; }
    .btn.primary { background: linear-gradient(135deg, #22c55e, #16a34a); border: 0; color: #ffffff; }
    .result { margin: 20px 0; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"><\/script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"><\/script>
</head>
<body>
  <div class="container">
    <h1>üé≤ Resultado del Sorteo Simple</h1>
    <div class="chips">${chipsHTML}</div>
    <div class="result">${listHTML}</div>
    <div class="controls">
      <button class="btn primary" onclick="exportPDF()">üñ®Ô∏è Exportar PDF</button>
    </div>
  </div>
  <script>
    function exportPDF() {
      try {
        if (!window.jspdf || !window.html2canvas) {
          alert('Librer√≠as de PDF no cargadas. Intenta recargar la p√°gina.');
          return;
        }

        const sheet = document.createElement('div');
        sheet.style.width = '794px';
        sheet.style.height: '1123px';
        sheet.style.background = '#ffffff';
        sheet.style.color = '#0f172a';
        sheet.style.position = 'fixed';
        sheet.style.left = '-9999px';
        sheet.style.top = '0';
        sheet.style.display = 'flex';
        sheet.style.flexDirection = 'column';
        sheet.style.fontFamily = 'system-ui, sans-serif';
        sheet.style.padding = '20px';

        // Header
        const header = document.createElement('div');
        header.innerHTML = '<h1 style="margin: 0 0 16px 0; font-size: 24px;">Resultado del Sorteo Simple</h1>';
        sheet.appendChild(header);

        // Chips
        const chips = document.createElement('div');
        chips.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;';
        chips.innerHTML = '${chipsHTML.replace(/'/g, "\\'")}';
        sheet.appendChild(chips);

        // Result list
        const resultDiv = document.createElement('div');
        resultDiv.style.cssText = 'flex: 1;';
        resultDiv.innerHTML = '${listHTML.replace(/'/g, "\\'")}';
        sheet.appendChild(resultDiv);

        document.body.appendChild(sheet);

        html2canvas(sheet, { 
          backgroundColor: '#ffffff',
          scale: 2,
          useCORS: true 
        }).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          document.body.removeChild(sheet);

          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'pt',
            format: 'a4'
          });

          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          
          pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
          pdf.save('sorteo_simple_${new Date().toISOString().slice(0,10)}.pdf');
        });

      } catch (error) {
        console.error('Error generando PDF:', error);
        alert('Error al generar PDF: ' + error.message);
      }
    }
  <\/script>
</body>
</html>`;
  
  w.document.open();
  w.document.write(html);
  w.document.close();
}

// ====================== FUNCIONES EXISTENTES (resumidas) ======================
function escapeHtml(text) {
  const map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};
  return text.replace(/[&<>"']/g, m => map[m]);
}

function toast(msg) {
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.cssText = 'position:fixed;bottom:16px;right:16px;background:#111827;border:1px solid #334155;padding:10px 12px;border-radius:10px;z-index:9999;';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1500);
}

// ... (todas las dem√°s funciones existentes se mantienen igual) ...

// ====================== MODIFICACIONES EN LOS SORTEOS ======================

// En el sorteo de grupos, despu√©s del √©xito:
function handleGroupsSuccess(result, teams, z) {
  // ... c√≥digo existente ...
  
  // Guardar en el historial
  const parameters = {
    discipline: document.getElementById('disciplineSelect').options[document.getElementById('disciplineSelect').selectedIndex]?.text || '',
    category: document.getElementById('categorySelect').value || '',
    gender: document.getElementById('genderSelect').value || ''
  };
  saveDraw('grupos', parameters, result);
}

// En el sorteo simple, despu√©s del √©xito:
function handleSimpleSuccess(shuffled) {
  // ... c√≥digo existente ...
  
  // Guardar en el historial
  const parameters = {
    discipline: document.getElementById('disciplineSelectSimple').options[document.getElementById('disciplineSelectSimple').selectedIndex]?.text || '',
    category: '',
    gender: ''
  };
  saveDraw('simple', parameters, { list: shuffled });
}

// ====================== INICIALIZACI√ìN ======================
document.addEventListener('DOMContentLoaded', function() {
  console.log('Sorteador v3.0 cargado');
  
  // Tabs
  document.querySelectorAll('.tab').forEach(btn => {
    btn.addEventListener('click', () => {
      const tabName = btn.dataset.tab;
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tabcontent').forEach(c => c.classList.add('hidden'));
      btn.classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.remove('hidden');
      
      // Si es la pesta√±a de guardados, renderizar
      if (tabName === 'saved') {
        renderSavedDraws();
      }
    });
  });
  
  // ... (resto del c√≥digo de inicializaci√≥n existente) ...
  
  // Sorteo simple - Exportar PDF
  document.getElementById('btnExportPDFSimple').addEventListener('click', () => {
    const names = document.getElementById('resultSimple').textContent
      .split('\n')
      .map(line => line.replace(/^\d+\.\s*/, '').trim())
      .filter(name => name.length > 0);
    
    if (names.length === 0) {
      toast('No hay resultado para exportar');
      return;
    }
    
    const parameters = {
      discipline: document.getElementById('disciplineSelectSimple').options[document.getElementById('disciplineSelectSimple').selectedIndex]?.text || '',
      category: '',
      gender: ''
    };
    
    openSimpleResultInNewTab({ list: names }, parameters);
  });
  
  // Modificar el evento del sorteo simple para guardar
  document.getElementById('btnDrawSimple').addEventListener('click', () => {
    const seed = document.getElementById('disciplineSelectSimple').value || 'sorteo';
    const names = document.getElementById('simpleInput').value.split('\n')
      .map(name => name.trim())
      .filter(name => name.length > 0);
    
    if (names.length === 0) {
      document.getElementById('statusSimple').innerHTML = '<span class="errorText">No hay equipos</span>';
      return;
    }
    
    const rand = rngFromSeed(seed);
    const shuffled = shuffle(names, rand);
    
    const resultHTML = shuffled.map((name, index) => 
      `<div>${index + 1}. <b>${escapeHtml(name)}</b></div>`
    ).join('');
    
    document.getElementById('resultSimple').innerHTML = resultHTML;
    document.getElementById('statusSimple').innerHTML = 'Sorteo realizado';
    
    // Guardar en el historial
    handleSimpleSuccess(shuffled);
  });
  
  // Modificar el evento del sorteo de grupos para guardar
  document.getElementById('btnDrawGroups').addEventListener('click', () => {
    const teams = getActiveTeamsLive();
    if (teams.length === 0) {
      document.getElementById('status').innerHTML = '<span class="errorText">No hay equipos activos</span>';
      return;
    }
    
    const z = currentZones();
    const seed = document.getElementById('disciplineSelect').value || 'sorteo';
    const headsAsFirst = document.getElementById('headsAsFirst').checked;
    const format = getFormat();
    
    const result = drawGroups(teams, z, headsAsFirst, seed, format);
    renderGroups(document.getElementById('resultGroups'), result);
    
    if (!result.error) {
      openResultInNewTab(result);
      handleGroupsSuccess(result, teams, z);
    }
  });
  
  // Inicializaci√≥n
  updateCapInfo();
});

// ... (resto de las funciones existentes se mantienen igual) ...
</script>
</body>
</html>
